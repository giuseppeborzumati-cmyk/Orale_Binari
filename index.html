<html lang="it">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Generatore Verifiche Informatica - Borzumati</title>
Â  Â  <!-- Carica Tailwind CSS -->
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <style>
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap');
Â  Â  Â  Â  body { font-family: 'Inter', sans-serif; }
Â  Â  Â  Â  .code-font { font-family: 'Roboto Mono', monospace; }
Â  Â  Â  Â  .code-block { background-color: #1e293b; color: #f8fafc; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; }

Â  Â  Â  Â  /* Stili per la stampa PDF (ottimizzazione 2 pagine A4) */
Â  Â  Â  Â  @media print {
Â  Â  Â  Â  Â  Â  body { font-family: sans-serif !important; font-size: 10pt; background: white !important; }
Â  Â  Â  Â  Â  Â  body > *:not(.print-container) { display: none !important; }
Â  Â  Â  Â  Â  Â  .print-container { 
Â  Â  Â  Â  Â  Â  Â  Â  display: block !important; 
Â  Â  Â  Â  Â  Â  Â  Â  max-width: none !important; 
Â  Â  Â  Â  Â  Â  Â  Â  margin: 0 !important; 
Â  Â  Â  Â  Â  Â  Â  Â  padding: 0 !important; 
Â  Â  Â  Â  Â  Â  Â  Â  box-shadow: none !important; 
Â  Â  Â  Â  Â  Â  Â  Â  height: auto;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  @page { margin: 1.5cm 1cm; }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  .print-header { border-bottom: 2px solid #6366f1; padding-bottom: 0.5rem; margin-bottom: 1rem; }
Â  Â  Â  Â  Â  Â  .print-header h1 { font-size: 16pt !important; font-weight: 900; }
Â  Â  Â  Â  Â  Â  .print-header p { font-size: 10pt !important; color: #374151; }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  .question-item { 
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 1.2rem; 
Â  Â  Â  Â  Â  Â  Â  Â  page-break-inside: avoid;
Â  Â  Â  Â  Â  Â  Â  Â  border-left: 4px solid #6366f1;
Â  Â  Â  Â  Â  Â  Â  Â  padding-left: 0.75rem;
Â  Â  Â  Â  Â  Â  Â  Â  counter-increment: question-counter;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .question-item::before {
Â  Â  Â  Â  Â  Â  Â  Â  content: counter(question-counter) ". ";
Â  Â  Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  Â  Â  margin-right: 0.25rem;
Â  Â  Â  Â  Â  Â  Â  Â  color: #6366f1;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .question-text { font-weight: 700; color: #1f2937; margin-bottom: 0.3rem; }
Â  Â  Â  Â  Â  Â  .answer-line { 
Â  Â  Â  Â  Â  Â  Â  Â  height: 1.2em; 
Â  Â  Â  Â  Â  Â  Â  Â  display: block; 
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: 1px dashed #9ca3af; 
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%; 
Â  Â  Â  Â  Â  Â  Â  Â  margin-top: 0.2rem; 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .solution-box { 
Â  Â  Â  Â  Â  Â  Â  Â  border: 1px solid #10b981; 
Â  Â  Â  Â  Â  Â  Â  Â  background-color: #d1fae5; 
Â  Â  Â  Â  Â  Â  Â  Â  padding: 0.2rem 0.5rem; 
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 4px; 
Â  Â  Â  Â  Â  Â  Â  Â  margin-top: 0.4rem; 
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 9pt;
Â  Â  Â  Â  Â  Â  Â  Â  font-family: 'Roboto Mono', monospace;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Stili per i pulsanti animati */
Â  Â  Â  Â  .action-button { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); font-weight: 700; position: relative; overflow: hidden; }
Â  Â  Â  Â  .action-button:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
Â  Â  Â  Â  .action-button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.2); transform: skewX(-20deg); transition: all 0.7s; }
Â  Â  Â  Â  .action-button:hover::before { left: 100%; }
Â  Â  Â  Â  .bg-gradient-blue { background-image: linear-gradient(to right, #4c66ff 0%, #00c6ff 100%); }
Â  Â  Â  Â  .bg-gradient-green { background-image: linear-gradient(to right, #10b981 0%, #1d7c4c 100%); }
Â  Â  </style>
</head>
<body class="bg-gray-900 min-h-screen p-4 sm:p-8">

Â  Â  <!-- Area di caricamento -->
Â  Â  <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex items-center justify-center hidden">
Â  Â  Â  Â  <div class="text-center text-white">
Â  Â  Â  Â  Â  Â  <svg class="animate-spin h-10 w-10 text-indigo-400 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
Â  Â  Â  Â  Â  Â  Â  Â  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
Â  Â  Â  Â  Â  Â  Â  Â  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  <p class="text-lg font-semibold">Caricamento dati in corso... (Connessione a Firebase)</p>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  
Â  Â  <!-- Sezione Dati Studente/Docente e Introduzione -->
Â  Â  <div id="main-view" class="w-full max-w-7xl mx-auto bg-white rounded-xl shadow-[0_25px_50px_-12px_rgba(0,0,0,0.5)] p-6 sm:p-12 mb-8 space-y-10">
Â  Â  Â  Â  <header class="text-center pb-6 border-b-4 border-indigo-500">
Â  Â  Â  Â  Â  Â  <h1 class="text-4xl sm:text-6xl font-black leading-tight">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-purple-600"> GENERATORE VERIFICHE INFORMATICA </span>
Â  Â  Â  Â  Â  Â  </h1>
Â  Â  Â  Â  Â  Â  <p class="text-xl text-gray-700 mt-2">Prof. Giuseppe Borzumati | 11 Domande Miste Pratica + Teoria Semplice</p>
Â  Â  Â  Â  </header>

Â  Â  Â  Â  <!-- Dati Studente per la Generazione (Globali) -->
Â  Â  Â  Â  <div class="bg-indigo-50 p-8 rounded-2xl shadow-inner border border-indigo-200">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-indigo-800 mb-5 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 mr-2 text-indigo-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
Â  Â  Â  Â  Â  Â  Â  Â  </svg> 
Â  Â  Â  Â  Â  Â  Â  Â  Dati Base
Â  Â  Â  Â  Â  Â  Â  Â  <span id="teacher-id" class="code-font text-xs ml-4 p-1 bg-indigo-200 text-indigo-800 rounded"></span>
Â  Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
Â  Â  Â  Â  Â  Â  Â  Â  <div> <input type="text" id="nome-studente" placeholder="Nome" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div> <input type="text" id="cognome-studente" placeholder="Cognome" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div> <input type="text" id="classe-studente" placeholder="Classe (es. 4B)" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div> <input type="date" id="data-verifica" value="" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p class="text-sm text-indigo-600 mt-4 font-semibold">Tutti i campi sono obbligatori per generare il link di correzione.</p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Contenitore delle Verifiche (4 Blocchi) -->
Â  Â  Â  Â  <div class="space-y-12">

Â  Â  Â  Â  Â  Â  <!-- BLOCCO 1: Verifiche Numeriche PURE -->
Â  Â  Â  Â  Â  Â  <div id="blocco-verifica-a" class="p-8 bg-red-50 border-t-8 border-t-red-500 rounded-2xl shadow-3xl">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-3xl font-bold text-red-700 mb-4 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="mr-3 text-4xl">ğŸ”¢</span> VERIFICA A: Sistemi di Numerazione Base & Operazioni
Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-600 mb-6">Tracce: Conversione Base (2, 8, 10, 16), Frazioni Binarie, Numeri Romani e Operazioni Binaria. (11 Domande Miste)</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col sm:flex-row gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('A', true)"> ğŸ“„ Genera PDF Alunno </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('A', false)"> ğŸ“ Genera PDF Docente (Soluzioni) </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="link-container-A" class="mt-6 space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-lg font-semibold text-red-600 border-b border-red-300 pb-1">Link di Correzione Generati (Verifica A):</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500" id="link-message-A">Nessuna verifica di Tipo A generata.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <!-- BLOCCO 2: A + Networking Semplice -->
Â  Â  Â  Â  Â  Â  <div id="blocco-verifica-b" class="p-8 bg-purple-50 border-t-8 border-t-purple-500 rounded-2xl shadow-3xl">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-3xl font-bold text-purple-700 mb-4 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="mr-3 text-4xl">ğŸŒ</span> VERIFICA B: Sistemi di Numerazione + Networking Semplice
Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-600 mb-6">Tracce: Contenuti della Verifica A + Subnetting Semplice (CIDR, Network/Broadcast ID, Maschera). (11 Domande Miste)</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col sm:flex-row gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('B', true)"> ğŸ“„ Genera PDF Alunno </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('B', false)"> ğŸ“ Genera PDF Docente (Soluzioni) </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="link-container-B" class="mt-6 space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-lg font-semibold text-purple-600 border-b border-purple-300 pb-1">Link di Correzione Generati (Verifica B):</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500" id="link-message-B">Nessuna verifica di Tipo B generata.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <!-- BLOCCO 3: A + Networking Semplice (uguale a B per bilanciamento) -->
Â  Â  Â  Â  Â  Â  <div id="blocco-verifica-c" class="p-8 bg-teal-50 border-t-8 border-t-teal-500 rounded-2xl shadow-3xl">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-3xl font-bold text-teal-700 mb-4 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="mr-3 text-4xl">ğŸ”¬</span> VERIFICA C: Sistemi di Numerazione + Networking Semplice
Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-600 mb-6">Tracce: Contenuti della Verifica A + Subnetting Semplice (CIDR, Network/Broadcast ID, Maschera). (11 Domande Miste) - Ideale per un'alternativa alla B.</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col sm:flex-row gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('C', true)"> ğŸ“„ Genera PDF Alunno </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('C', false)"> ğŸ“ Genera PDF Docente (Soluzioni) </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="link-container-C" class="mt-6 space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-lg font-semibold text-teal-600 border-b border-teal-300 pb-1">Link di Correzione Generati (Verifica C):</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500" id="link-message-C">Nessuna verifica di Tipo C generata.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <!-- BLOCCO 4: Riepilogo Completo e Problemi Critici (Verifica D) -->
Â  Â  Â  Â  Â  Â  <div id="blocco-verifica-d" class="p-8 bg-yellow-50 border-t-8 border-t-yellow-500 rounded-2xl shadow-3xl">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-3xl font-bold text-yellow-800 mb-4 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="mr-3 text-4xl">â­</span> VERIFICA D: Riepilogo Completo (Complemento a 2, Floating Point, IP Avanzato)
Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-600 mb-6">Tracce: Mix di tutti gli argomenti avanzati: Complemento a Due, Floating Point e Subnetting complesso (VLSM/CIDR). (11 Domande Miste)</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col sm:flex-row gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('D', true)"> ğŸ“„ Genera PDF Alunno </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('D', false)"> ğŸ“ Genera PDF Docente (Soluzioni) </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="link-container-D" class="mt-6 space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-lg font-semibold text-yellow-600 border-b border-yellow-300 pb-1">Link di Correzione Generati (Verifica D):</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500" id="link-message-D">Nessuna verifica di Tipo D generata.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  Â  Â  <footer class="text-center pt-8 text-gray-500 text-sm border-t border-gray-200">
Â  Â  Â  Â  Â  Â  <p>Sistema di Generazione Verifiche v5.2 | Per l'Insegnante Giuseppe Borzumati. Assicurati che il pop-up del browser sia consentito per scaricare il PDF.</p>
Â  Â  Â  Â  </footer>
Â  Â  </div>

Â  Â  <!-- VISTA DI CORREZIONE (Caricata tramite link condivisibile) -->
Â  Â  <div id="correction-view" class="hidden w-full max-w-5xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10 mb-8 space-y-8">
Â  Â  Â  Â  <header class="text-center pb-4 border-b-4 border-green-500">
Â  Â  Â  Â  Â  Â  <h1 class="text-4xl font-extrabold text-green-700 leading-tight">Griglia di Correzione Interattiva</h1>
Â  Â  Â  Â  Â  Â  <p class="text-lg text-gray-600 mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Studente: <span id="corr-student-name" class="font-extrabold text-indigo-600"></span> - 
Â  Â  Â  Â  Â  Â  Â  Â  Classe: <span id="corr-class" class="font-extrabold text-indigo-600"></span> - 
Â  Â  Â  Â  Â  Â  Â  Â  Verifica <span id="corr-title" class="font-bold"></span>
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  </header>

Â  Â  Â  Â  <!-- Tabella Punteggio e Voto -->
Â  Â  Â  Â  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 bg-yellow-50 p-6 rounded-xl border-2 border-yellow-300 shadow-lg">
Â  Â  Â  Â  Â  Â  <div class="col-span-1 lg:col-span-3">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-yellow-800 mb-2 border-b border-yellow-400 pb-1">Valutazione</h2>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div class="bg-blue-100 p-4 rounded-lg shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-semibold text-blue-800">Punti Ottenuti:</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-4xl font-extrabold text-blue-600 mt-1"><span id="corr-points">0</span> / <span id="corr-max-points">11</span></p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div class="bg-purple-100 p-4 rounded-lg shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-semibold text-purple-800">Voto Orale (Base 10):</p>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="voto-orale" min="0" max="10" step="0.1" value="6.0" onchange="updateFinalGrade()" class="p-2 border-2 border-purple-500 rounded-lg w-full mt-1 text-xl font-bold">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div class="bg-red-100 p-4 rounded-lg shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-semibold text-red-800">Voto Finale (Arrotondato per Difetto):</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-4xl font-extrabold text-red-600 mt-1"><span id="corr-grade-floored">0</span> / 10</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div class="col-span-1 lg:col-span-3 bg-gray-100 p-4 rounded-lg border border-gray-300" id="conversion-explanation">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-bold text-gray-700">Formula di Calcolo:</p>
Â  Â  Â  Â  Â  Â  Â  Â  <code class="code-font text-xs block mt-1 p-2 bg-white rounded"> Voto Scritto Base 10 = (Punti Ottenuti / 11) * 10 = <span id="voto-scritto-base">0.00</span> </code>
Â  Â  Â  Â  Â  Â  Â  Â  <code class="code-font text-xs block mt-1 p-2 bg-white rounded"> Voto Finale = (Voto Scritto * 0.7) + (Voto Orale * 0.3) </code>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Esercizi con Correzione -->
Â  Â  Â  Â  <div id="correction-form" class="space-y-6"> 
Â  Â  Â  Â  Â  Â  <!-- Gli esercizi e i campi di input saranno popolati qui dal JS -->
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <button class="action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-lg mt-8 w-full" onclick="saveAndDownloadResultsPDF()"> Salva Risultati e Scarica PDF dei Commenti </button>
Â  Â  Â  Â  <button class="action-button bg-gray-400 hover:bg-gray-500 text-gray-900 py-3 px-6 rounded-lg text-lg w-full" onclick="window.location.href = window.location.origin + window.location.pathname"> Torna alla Generazione Verifiche </button>
Â  Â  </div>

Â  Â  <!-- Contenitore Nascosto per la Stampa PDF (Stile ottimizzato per PDF) -->
Â  Â  <div id="print-area" class="print-container hidden"></div>

Â  Â  <!-- Firebase SDK Imports -->
Â  Â  <script type="module">
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
Â  Â  Â  Â  import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
Â  Â  Â  Â  import { getFirestore, collection, doc, setDoc, getDoc, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
Â  Â  Â  Â  
Â  Â  Â  Â  // Imposta il livello di log per debug
Â  Â  Â  Â  setLogLevel('Debug');

Â  Â  Â  Â  // Variabili Globali del Modulo
Â  Â  Â  Â  window.db = null;
Â  Â  Â  Â  window.auth = null;
Â  Â  Â  Â  window.teacherId = null;
Â  Â  Â  Â  window.MAX_POINTS = 11; // Punti massimi per la verifica (1 punto per domanda)

Â  Â  Â  Â  // Configurazione Firebase: Usa le variabili globali se disponibili, altrimenti il fallback fornito dall'utente.
Â  Â  Â  Â  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyDtruKdnoFjMqob-1zf-Zw0hXn8j_YwVio",
Â  Â  Â  Â  Â  Â  authDomain: "verifichenumeribinari.firebaseapp.com",
Â  Â  Â  Â  Â  Â  projectId: "verifichenumeribinari",
Â  Â  Â  Â  Â  Â  storageBucket: "verifichenumeribinari.firebasestorage.app",
Â  Â  Â  Â  Â  Â  messagingSenderId: "648812468179",
Â  Â  Â  Â  Â  Â  appId: "1:648812468179:web:1a0e2d65cb1aae28e60126",
Â  Â  Â  Â  Â  Â  measurementId: "G-K5SL1808G4"
Â  Â  Â  Â  };
Â  Â  Â  Â  
Â  Â  Â  Â  // Variabile ID App (usata per il path Firestore)
Â  Â  Â  Â  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

Â  Â  Â  Â  // Funzione di Inizializzazione Firebase
Â  Â  Â  Â  async function initializeFirebase() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // 1. Inizializzazione App
Â  Â  Â  Â  Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  Â  Â  window.db = getFirestore(app);
Â  Â  Â  Â  Â  Â  Â  Â  window.auth = getAuth(app);

Â  Â  Â  Â  Â  Â  Â  Â  // 2. Autenticazione Anonima o con Token
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof __initial_auth_token !== 'undefined') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInWithCustomToken(window.auth, __initial_auth_token);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInAnonymously(window.auth);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  window.teacherId = window.auth.currentUser.uid;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // 3. Nascondi Overlay e Avvia l'app
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loading-overlay').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('teacher-id').textContent = `Docente ID: ${window.teacherId.substring(0, 8)}...`;

Â  Â  Â  Â  Â  Â  Â  Â  // 4. Carica i link di correzione esistenti
Â  Â  Â  Â  Â  Â  Â  Â  await window.updateLinkContainers();

Â  Â  Â  Â  Â  Â  Â  Â  // 5. Verifica se Ã¨ una vista di correzione
Â  Â  Â  Â  Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  Â  Â  Â  Â  const examId = urlParams.get('examId');
Â  Â  Â  Â  Â  Â  Â  Â  if (examId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.showLoading();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await window.loadCorrectionView(examId);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.showMainView();
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Errore fatale nell'inizializzazione di Firebase e Auth:", error);
Â  Â  Â  Â  Â  Â  Â  Â  // Sostituisci alert() con un messaggio sulla console o un modale custom
Â  Â  Â  Â  Â  Â  Â  Â  const errorMsg = "Errore di connessione al database. Controlla la console per i dettagli. (ID App: " + appId + ")";
Â  Â  Â  Â  Â  Â  Â  Â  console.log(errorMsg);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loading-overlay').classList.add('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Metodo per ottenere il path corretto per Firestore (pubblico)
Â  Â  Â  Â  window.getExamCollectionRef = () => {
Â  Â  Â  Â  Â  Â  Â return collection(window.db, "artifacts", appId, "public", "data", "exams");
Â  Â  Â  Â  };

Â  Â  Â  Â  // ESPORTA LE FUNZIONI DI FIRESTORE NEL CONTESTO GLOBALE
Â  Â  Â  Â  window.getDoc = getDoc;
Â  Â  Â  Â  window.setDoc = setDoc;
Â  Â  Â  Â  window.doc = doc;
Â  Â  Â  Â  window.collection = collection;
Â  Â  Â  Â  window.query = query;
Â  Â  Â  Â  window.where = where;
Â  Â  Â  Â  window.getDocs = getDocs;

Â  Â  Â  Â  // Esegui l'inizializzazione al caricamento
Â  Â  Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  Â  Â  initializeFirebase();
Â  Â  Â  Â  Â  Â  const today = new Date().toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  document.getElementById('data-verifica').value = today;
Â  Â  Â  Â  Â  Â  document.getElementById('corr-max-points').textContent = window.MAX_POINTS;
Â  Â  Â  Â  });
Â  Â  </script>
Â  Â  
Â  Â  <script>
Â  Â  Â  Â  // -------------------------------------------------------------------------
Â  Â  Â  Â  // LOGICA DI VISTA E UTILITY
Â  Â  Â  Â  // -------------------------------------------------------------------------

Â  Â  Â  Â  let currentExamData = null; // Dati della verifica attualmente in correzione
Â  Â  Â  Â  
Â  Â  Â  Â  window.showLoading = () => document.getElementById('loading-overlay').classList.remove('hidden');
Â  Â  Â  Â  window.hideLoading = () => document.getElementById('loading-overlay').classList.add('hidden');

Â  Â  Â  Â  // Navigazione tra le viste
Â  Â  Â  Â  window.showMainView = () => {
Â  Â  Â  Â  Â  Â  document.getElementById('main-view').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('correction-view').classList.add('hidden');
Â  Â  Â  Â  Â  Â  window.hideLoading();
Â  Â  Â  Â  };

Â  Â  Â  Â  // Funzione per generare un ID unico
Â  Â  Â  Â  const generateUniqueID = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 5);

Â  Â  Â  Â  // Funzione per pulire e standardizzare le risposte (tolleranza)
Â  Â  Â  Â  const cleanAnswer = (s) => s.toString()
Â  Â  Â  Â  Â  Â  .trim()
Â  Â  Â  Â  Â  Â  .toUpperCase()
Â  Â  Â  Â  Â  Â  .replace(/[^A-Z0-9\.\/\;\-\+\s]/g, '') // Rimuove caratteri non validi
Â  Â  Â  Â  Â  Â  .replace(/\s+/g, ''); // Rimuove tutti gli spazi

Â  Â  Â  Â  // -------------------------------------------------------------------------
Â  Â  Â  Â  // FUNZIONI NUMERICHE DI CALCOLO (CRITICHE)
Â  Â  Â  Â  // -------------------------------------------------------------------------

Â  Â  Â  Â  // Genera un numero intero casuale in un range (incluso)
Â  Â  Â  Â  const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

Â  Â  Â  Â  // Conversione da base B a Decimale
Â  Â  Â  Â  function convertToBase10(numStr, base) {
Â  Â  Â  Â  Â  Â  return parseInt(numStr, base);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Conversione Decimale a Base B
Â  Â  Â  Â  function convertFromBase10(numDec, base) {
Â  Â  Â  Â  Â  Â  return numDec.toString(base).toUpperCase();
Â  Â  Â  Â  }

Â  Â  Â  Â  // Funzione per generare un numero binario con parte frazionaria
Â  Â  Â  Â  function generateBinaryFractional() {
Â  Â  Â  Â  Â  Â  const integerPart = randInt(10, 30);
Â  Â  Â  Â  Â  Â  let binFractional = '';
Â  Â  Â  Â  Â  Â  let fractionalValue = 0;

Â  Â  Â  Â  Â  Â  // Assicurati che non ci siano troppi zeri iniziali o finali inutili
Â  Â  Â  Â  Â  Â  for (let i = 0; i < 4; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const bit = randInt(0, 1);
Â  Â  Â  Â  Â  Â  Â  Â  binFractional += bit;
Â  Â  Â  Â  Â  Â  Â  Â  fractionalValue += bit * Math.pow(2, -(i + 1));
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const decimalValue = integerPart + fractionalValue;
Â  Â  Â  Â  Â  Â  const binaryValue = integerPart.toString(2) + '.' + binFractional.replace(/0+$/, ''); // Rimuove gli zeri finali
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  return { decimal: parseFloat(decimalValue.toFixed(4)), binary: binaryValue };
Â  Â  Â  Â  }

Â  Â  Â  Â  // Funzione per calcolare il Complemento a Due (8 bit)
Â  Â  Â  Â  function toTwosComplement(num) {
Â  Â  Â  Â  Â  Â  if (num < -128 || num > 127) return 'OUT_OF_RANGE';
Â  Â  Â  Â  Â  Â  if (num >= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  return num.toString(2).padStart(8, '0');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const absNum = Math.abs(num);
Â  Â  Â  Â  Â  Â  // Converti in binario positivo a 8 bit
Â  Â  Â  Â  Â  Â  let binPos = absNum.toString(2).padStart(8, '0');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Inverti i bit
Â  Â  Â  Â  Â  Â  let inverted = [...binPos].map(b => b === '0' ? '1' : '0').join('');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Aggiungi 1 (in binario)
Â  Â  Â  Â  Â  Â  let sumBin = (parseInt(inverted, 2) + 1).toString(2);
Â  Â  Â  Â  Â  Â  return sumBin.padStart(8, '0').slice(-8);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Conversione Decimale a Romano (fino a 999)
Â  Â  Â  Â  function decToRoman(num) {
Â  Â  Â  Â  Â  Â  if (num > 999) return "ERR_MAX";
Â  Â  Â  Â  Â  Â  const map = { 1000: 'M', 900: 'CM', 500: 'D', 400: 'CD', 100: 'C', 90: 'XC', 50: 'L', 40: 'XL', 10: 'X', 9: 'IX', 5: 'V', 4: 'IV', 1: 'I' };
Â  Â  Â  Â  Â  Â  let roman = '';
Â  Â  Â  Â  Â  Â  for (let i of Object.keys(map).map(Number).sort((a, b) => b - a)) {
Â  Â  Â  Â  Â  Â  Â  Â  while (num >= i) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  roman += map[i];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  num -= i;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return roman;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Calcolo Notazione Scientifica Binaria (Floating Point Semplificato - Mantissa 10 bit, Esponente offset 7)
Â  Â  Â  Â  function calculateFloatingPoint(dec) {
Â  Â  Â  Â  Â  Â  let sign = dec >= 0 ? 0 : 1;
Â  Â  Â  Â  Â  Â  let num = Math.abs(dec);
Â  Â  Â  Â  Â  Â  if (num === 0) return { sign, exponent: '0000000', mantissa: '0'.repeat(10), full: '0' };

Â  Â  Â  Â  Â  Â  const integerPart = Math.floor(num);
Â  Â  Â  Â  Â  Â  let fractionalPart = num - integerPart;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let binary = integerPart.toString(2);
Â  Â  Â  Â  Â  Â  let fracBin = '';

Â  Â  Â  Â  Â  Â  let tempFrac = fractionalPart;
Â  Â  Â  Â  Â  Â  for (let i = 0; i < 15; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  tempFrac *= 2;
Â  Â  Â  Â  Â  Â  Â  Â  let bit = Math.floor(tempFrac);
Â  Â  Â  Â  Â  Â  Â  Â  fracBin += bit;
Â  Â  Â  Â  Â  Â  Â  Â  tempFrac -= bit;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  binary += '.' + fracBin;

Â  Â  Â  Â  Â  Â  // Trova la posizione del primo '1' per la normalizzazione
Â  Â  Â  Â  Â  Â  let firstOneIndex = binary.indexOf('1');
Â  Â  Â  Â  Â  Â  let dotIndex = binary.indexOf('.');
Â  Â  Â  Â  Â  Â  let E; // Esponente puro (spostamento)

Â  Â  Â  Â  Â  Â  if (integerPart > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  E = dotIndex - firstOneIndex - 1;
Â  Â  Â  Â  Â  Â  } else { // < 1
Â  Â  Â  Â  Â  Â  Â  Â  E = dotIndex - firstOneIndex;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Esponente biased (offset 7)
Â  Â  Â  Â  Â  Â  let biasedE = E + 7;
Â  Â  Â  Â  Â  Â  if (biasedE < 0 || biasedE > 15) return { sign, exponent: 'RANGE_ERR', mantissa: 'RANGE_ERR' };
Â  Â  Â  Â  Â  Â  const expBin = biasedE.toString(2).padStart(4, '0'); // 4 bit per l'esponente

Â  Â  Â  Â  Â  Â  // Mantissa (rimuovi 1 implicito e prendi 10 bit)
Â  Â  Â  Â  Â  Â  let normalized = binary.replace('.', '');
Â  Â  Â  Â  Â  Â  let mantissaStart = normalized.substring(firstOneIndex + 1);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const mantissa = mantissaStart.padEnd(10, '0').substring(0, 10);
Â  Â  Â  Â  Â  Â  const full = `${sign}${expBin}${mantissa}`;

Â  Â  Â  Â  Â  Â  return { sign, exponent: expBin, mantissa, full };
Â  Â  Â  Â  }

Â  Â  Â  Â  // Funzione per calcolare ID Rete/Broadcast/Maschera
Â  Â  Â  Â  function calculateNetworkIDs(ip, cidr) {
Â  Â  Â  Â  Â  Â  const mask = parseInt(cidr, 10);
Â  Â  Â  Â  Â  Â  const octets = ip.split('.').map(o => parseInt(o));
Â  Â  Â  Â  Â  Â  const ipBin = octets.map(o => o.toString(2).padStart(8, '0')).join('');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const networkPart = ipBin.substring(0, mask);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Network ID (host part = 0)
Â  Â  Â  Â  Â  Â  const netIDBinary = networkPart.padEnd(32, '0');
Â  Â  Â  Â  Â  Â  let networkID = [];
Â  Â  Â  Â  Â  Â  for (let n = 0; n < 4; n++) {
Â  Â  Â  Â  Â  Â  Â  Â  networkID.push(parseInt(netIDBinary.substring(n * 8, n * 8 + 8), 2));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const netID = networkID.join('.');

Â  Â  Â  Â  Â  Â  // Broadcast ID (host part = 1)
Â  Â  Â  Â  Â  Â  const hostPart = '1'.repeat(32 - mask);
Â  Â  Â  Â  Â  Â  const broadcastBinary = networkPart + hostPart;
Â  Â  Â  Â  Â  Â  let broadcastID = [];
Â  Â  Â  Â  Â  Â  for (let n = 0; n < 4; n++) {
Â  Â  Â  Â  Â  Â  Â  Â  broadcastID.push(parseInt(broadcastBinary.substring(n * 8, n * 8 + 8), 2));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const bcastID = broadcastID.join('.');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Maschera decimale
Â  Â  Â  Â  Â  Â  const maskBin = '1'.repeat(mask).padEnd(32, '0');
Â  Â  Â  Â  Â  Â  let maskDec = [];
Â  Â  Â  Â  Â  Â  for (let n = 0; n < 4; n++) {
Â  Â  Â  Â  Â  Â  Â  Â  maskDec.push(parseInt(maskBin.substring(n * 8, n * 8 + 8), 2));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const subnetMask = maskDec.join('.');

Â  Â  Â  Â  Â  Â  return { network: netID, broadcast: bcastID, mask: subnetMask };
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // -------------------------------------------------------------------------
Â  Â  Â  Â  // POOL DI GENERATORI DI DOMANDE MISTE (11)
Â  Â  Â  Â  // -------------------------------------------------------------------------

Â  Â  Â  Â  function generateMixedQuestion(qNum, examType) {
Â  Â  Â  Â  Â  Â  let question = {};
Â  Â  Â  Â  Â  Â  let num1, num2, ip, cidr, result, type;
Â  Â  Â  Â  Â  Â  const isAdvanced = examType === 'D';
Â  Â  Â  Â  Â  Â  const isNetworking = examType === 'B' || examType === 'C' || examType === 'D';

Â  Â  Â  Â  Â  Â  switch (qNum) {
Â  Â  Â  Â  Â  Â  Â  Â  // Q1: Decimale -> Base X (2, 8, 16) + Teoria Semplice
Â  Â  Â  Â  Â  Â  Â  Â  case 1:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  num1 = randInt(100, 255);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const targetBase = randInt(0, 1) === 0 ? 2 : 16;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = convertFromBase10(num1, targetBase);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Converti il numero Decimale **${num1}** in **Base ${targetBase}**.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Dato un numero di 8 bit, qual Ã¨ l'**intervallo massimo** di valori che puÃ² rappresentare se si considerano solo numeri **senza segno** (unsigned)?`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.correct = result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  // Q2: Base X -> Decimale + Teoria (Posizione)
Â  Â  Â  Â  Â  Â  Â  Â  case 2:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  num1 = randInt(100, 300);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const inputBase = randInt(0, 1) === 0 ? 8 : 16;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const inputNum = convertFromBase10(num1, inputBase);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = num1.toString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Converti il numero **${inputNum} (Base ${inputBase})** in **Decimale**.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Spiega il concetto di **sistema di numerazione posizionale** (come il Binario e il Decimale), e come questo differisce dal sistema Romano.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.correct = result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  // Q3: Conversione Base 16 a Binario / Base 8 a Binario (Diretta)
Â  Â  Â  Â  Â  Â  Â  Â  case 3:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  num1 = randInt(500, 1500);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isHex = randInt(0, 1) === 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const startBase = isHex ? 16 : 8;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const inputNum3 = convertFromBase10(num1, startBase).slice(-3);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = convertToBase10(inputNum3, startBase).toString(2);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Converti il numero **${inputNum3} (Base ${startBase})** in **Binario**.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Spiega perchÃ© la conversione da Base ${startBase} a Binario e viceversa Ã¨ considerata una **conversione diretta** o *shortcut*, e qual Ã¨ il fattore chiave (potenza di due) che la rende tale.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.correct = result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  // Q4: Addizione Binaria (semplice, 8 bit)
Â  Â  Â  Â  Â  Â  Â  Â  case 4:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  num1 = randInt(20, 50);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  num2 = randInt(10, 40);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const bin1 = num1.toString(2).padStart(8, '0');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const bin2 = num2.toString(2).padStart(8, '0');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = (num1 + num2).toString(2).padStart(8, '0').slice(-8);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Esegui l'addizione binaria: **$${bin1} + ${bin2}$** (risultato in binario, 8 bit).
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Cos'Ã¨ il **Carry-out** (riporto finale) nell'addizione binaria? Spiega in breve la sua importanza nel contesto di un'architettura di sistema a $N$ bit.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.correct = result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  // Q5: Frazione Binaria -> Decimale + Teoria (Errore)
Â  Â  Â  Â  Â  Â  Â  Â  case 5:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fracNum = generateBinaryFractional();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = fracNum.decimal.toFixed(3);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Dato il numero Binario con la virgola **${fracNum.binary}**, calcola il suo equivalente in Base **DECIMALE** (risultato con 3 cifre decimali, separatore punto).
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Descrivi il concetto di **errore di rappresentazione** nelle frazioni binarie. Fai l'esempio di $0.1_{10}$ spiegando perchÃ© Ã¨ un problema comune.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.correct = result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  // Q6: Complemento a Due (Solo Avanzato) / Networking (Base)
Â  Â  Â  Â  Â  Â  Â  Â  case 6:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isAdvanced) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // D: Complemento a Due (8 bit)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  num1 = randInt(-100, -1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = toTwosComplement(num1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Converti il numero Decimale **${num1}** nel suo equivalente in **Complemento a Due** (8 bit).
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Qual Ã¨ il vantaggio principale dell'utilizzo del Complemento a Due (C2) nei sistemi di calcolo per rappresentare i numeri negativi?`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (isNetworking) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // B/C: Maschera da CIDR
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cidr = randInt(20, 29);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ip = `192.168.${randInt(1, 254)}.${randInt(1, 254)}`; // IP di esempio
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = calculateNetworkIDs(ip, cidr).mask;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Data una notazione CIDR di **/${cidr}**, scrivi la corrispondente **Subnet Mask** in notazione decimale puntata.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Spiega la funzione principale della **Subnet Mask** in una rete IP.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // A: Decimale -> Romani
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  num1 = randInt(100, 999);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = decToRoman(num1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Converti il numero Decimale **${num1}** nel suo equivalente in **Numeri Romani**.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Qual Ã¨ la limitazione piÃ¹ grande dei Numeri Romani rispetto al sistema Decimale, e perchÃ© Ã¨ cruciale per il calcolo?`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  // Q7: Floating Point / Networking (Net ID) / Base Mista
Â  Â  Â  Â  Â  Â  Â  Â  case 7:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isAdvanced) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // D: Floating Point (Semplificato 15 bit)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  num1 = randInt(3, 10) + (randInt(1, 9) / 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fpResult = calculateFloatingPoint(num1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = fpResult.full; // Segno + Esponente (4 bit) + Mantissa (10 bit)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Applica il formato Floating Point Semplificato (Segno 1, Esp. Bias 7 con 4 bit, Mantissa 10 bit) al numero Decimale **${num1}**. Risposta: **Segno+Esp+Mantissa**.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Spiega brevemente il ruolo della **Mantissa** e dell'**Esponente** in un numero Floating Point.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (isNetworking) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // B/C: Network ID da IP/Mask
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cidr = randInt(20, 29);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ip = `192.168.${randInt(1, 254)}.${randInt(1, 254)}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = calculateNetworkIDs(ip, cidr).network;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Dato l'indirizzo IP **${ip}/${cidr}**, calcola l'**Indirizzo di Rete (Network ID)** in notazione decimale puntata.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Spiega a cosa serve l'**Indirizzo di Rete** e in che modo si differenzia da un indirizzo host (come un PC o un router).`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // A: Base Mista (Decimale intermedio)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  num1 = randInt(50, 150);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const input8 = num1.toString(8);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = num1.toString(16).toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Converti il numero **${input8} (Base 8)** in **Esadecimale (Base 16)**.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Descrivi il processo di conversione da Base 8 a Base 16 passando per il Binario. Qual Ã¨ il vantaggio di usare questo metodo?`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  // Q8: Base Sconosciuta / CIDR -> Hosts / Floating Point
Â  Â  Â  Â  Â  Â  Â  Â  case 8:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isAdvanced) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // D: Calcola Host da CIDR (Avanzato)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cidr = randInt(22, 29);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = (Math.pow(2, 32 - cidr) - 2).toString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Data la notazione CIDR **/${cidr}**, quanti **Indirizzi Host** utilizzabili (esclusi Network e Broadcast) ci sono in questa subnet?
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Spiega il concetto di **VLSM (Variable Length Subnet Masking)** in poche parole. PerchÃ© Ã¨ importante per l'efficienza degli indirizzi IP?`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (isNetworking) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // B/C: CIDR -> Hosts (Semplice)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cidr = randInt(25, 29);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = (Math.pow(2, 32 - cidr) - 2).toString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Data la notazione CIDR **/${cidr}**, quanti **Indirizzi Host** utilizzabili (esclusi Network e Broadcast) ci sono in questa subnet?
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** A cosa serve l'**ARP (Address Resolution Protocol)**? Spiega in breve il suo ruolo nella comunicazione LAN.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // A: Identificazione Base Sconosciuta
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  num1 = randInt(150, 300);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const unknownBase = randInt(3, 7);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const inputNum8 = num1.toString(unknownBase);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = unknownBase.toString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Il numero **${inputNum8}** equivale a $100_{10}$. Qual Ã¨ la **Base $X$** in cui Ã¨ espresso il numero ${inputNum8}?
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Se la base di un sistema di numerazione Ã¨ $B$, quali cifre (simboli) puÃ² contenere? (Fornisci la formula generale).`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  // Q9: Indirizzo IP Broadcast ID / Teoria: Octet
Â  Â  Â  Â  Â  Â  Â  Â  case 9:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cidr = randInt(25, 29);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ip = `192.168.${randInt(1, 254)}.${randInt(1, 254)}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = calculateNetworkIDs(ip, cidr).broadcast;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Dato l'indirizzo IP **${ip}/${cidr}**, calcola l'**Indirizzo di Broadcast** in notazione decimale puntata.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Un indirizzo IP Ã¨ formato da quattro ottetti (octet), come in $192.168.1.25$. Cosa significa la parola **octet** in questo contesto, e qual Ã¨ il suo valore massimo in base 10?`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.correct = result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  // Q10: Conversione Decimale 28-10-16 / Teoria: Sottrazione C2
Â  Â  Â  Â  Â  Â  Â  Â  case 10:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  num1 = randInt(10, 50);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const num2_2 = randInt(10, 50);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = convertFromBase10(num1, 16).toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Dato il numero Decimale **$${num1}$**, convertilo in **Esadecimale**.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Per effettuare l'operazione di **sottrazione** in un calcolatore (es. $${num2_2} - ${num1}$), si puÃ² usare il Complemento a Due. Spiega in breve come viene trasformata l'operazione di sottrazione in una semplice operazione di somma.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.correct = result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  // Q11: Decimale -> Hex (indirizzi) / Teoria: Gateway
Â  Â  Â  Â  Â  Â  Â  Â  case 11:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  num1 = randInt(10, 255);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  num2 = randInt(10, 255);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = convertFromBase10(num1, 16).toUpperCase() + convertFromBase10(num2, 16).toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = `**PARTE PRATICA:** Converti gli ottetti Decimale **${num1}** e **${num2}** nel loro equivalente **Esadecimale** (concatenati).
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **PARTE TEORICA:** Cos'Ã¨ il **Gateway Predefinito** (Default Gateway) in una rete locale? Spiega in che modo Ã¨ essenziale per la navigazione internet.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.correct = result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.text = 'DOMANDA NON ASSEGNATA - Errore di generazione.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question.correct = 'ERRORE';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  question.id = `q${qNum}`;
Â  Â  Â  Â  Â  Â  return question;
Â  Â  Â  Â  }

Â  Â  Â  Â  // -------------------------------------------------------------------------
Â  Â  Â  Â  // LOGICA DI GENERAZIONE, STAMPA PDF E SALVATAGGIO
Â  Â  Â  Â  // -------------------------------------------------------------------------

Â  Â  Â  Â  // Funzione di generazione del contenuto HTML ottimizzato per la stampa
Â  Â  Â  Â  function createPrintableHtml(examData, isStudent) {
Â  Â  Â  Â  Â  Â  const isDocente = !isStudent;
Â  Â  Â  Â  Â  Â  let html = `
Â  Â  Â  Â  Â  Â  <div class="p-8">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="print-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-2xl font-black text-indigo-700">VERIFICA DI INFORMATICA - ${examData.type} (${isDocente ? 'DOCENTE - SOLUZIONI' : 'ALUNNO'})</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-700">Prof. Giuseppe Borzumati | Data: ${examData.date} | ID Univoco: ${examData.id}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-700">Argomenti: Sistemi di Numerazione & Networking (Livello ${examData.type})</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="my-4 p-3 border border-gray-300 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg font-bold">Alunno: ${examData.student.name} ${examData.student.surname} | Classe: ${examData.student.class}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs mt-1">ISTRUZIONI: Rispondi a tutte le 11 domande. La prima parte Ã¨ pratica (calcolo), la seconda Ã¨ teorica (spiegazione breve).</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <ol class="list-none p-0" style="counter-reset: question-counter;">
Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  examData.questions.forEach((q, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const qText = q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Conversione Markdown in HTML
Â  Â  Â  Â  Â  Â  Â  Â  const solutionHtml = isDocente 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<div class="solution-box">**SOLUZIONE:** ${q.correct}</div>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : `<div class="mt-4"><span class="answer-line"></span><span class="answer-line"></span></div>`; // Linee vuote per l'alunno

Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li class="question-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="question-text">${qText}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${solutionHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  </ol>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-8 pt-4 border-t border-gray-300 text-xs text-gray-500 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Generato con il sistema di Borzumati | Non conservare la copia PDF sul database.
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  return html;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // Funzione che gestisce la stampa del PDF (trigger nativo di download)
Â  Â  Â  Â  function generatePrintablePDF(examData, isStudent) {
Â  Â  Â  Â  Â  Â  const htmlContent = createPrintableHtml(examData, isStudent);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const printArea = document.getElementById('print-area');
Â  Â  Â  Â  Â  Â  printArea.innerHTML = htmlContent;

Â  Â  Â  Â  Â  Â  // Imposta il titolo della finestra per il nome del file PDF scaricato
Â  Â  Â  Â  Â  Â  const fileSuffix = isStudent ? 'ALUNNO' : 'DOCENTE_SOLUZIONI';
Â  Â  Â  Â  Â  Â  document.title = `Verifica_${examData.student.surname}_${examData.student.class}_${examData.type}_${fileSuffix}_${examData.date}.pdf`;

Â  Â  Â  Â  Â  Â  printArea.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Utilizza setTimeout per garantire che il DOM sia aggiornato prima della stampa
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  window.print();
Â  Â  Â  Â  Â  Â  Â  Â  printArea.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  // Ripristina il titolo
Â  Â  Â  Â  Â  Â  Â  Â  document.title = 'Generatore Verifiche Informatica - Borzumati';
Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Funzione principale chiamata dai bottoni
Â  Â  Â  Â  async function handleGeneration(examType, isStudent) {
Â  Â  Â  Â  Â  Â  if (!window.db || !window.teacherId) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Firebase non inizializzato o utente non autenticato.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 1. Recupera i dati di base
Â  Â  Â  Â  Â  Â  const nome = document.getElementById('nome-studente').value.trim();
Â  Â  Â  Â  Â  Â  const cognome = document.getElementById('cognome-studente').value.trim();
Â  Â  Â  Â  Â  Â  const classe = document.getElementById('classe-studente').value.trim();
Â  Â  Â  Â  Â  Â  const data = document.getElementById('data-verifica').value;

Â  Â  Â  Â  Â  Â  if (!nome || !cognome || !classe || !data) {
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Per favore, compila tutti i campi (Nome, Cognome, Classe, Data) prima di generare.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  window.showLoading();

Â  Â  Â  Â  Â  Â  // 2. Genera le 11 domande
Â  Â  Â  Â  Â  Â  const generatedQuestions = [];
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= window.MAX_POINTS; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  generatedQuestions.push(generateMixedQuestion(i, examType));
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 3. Crea il record della verifica
Â  Â  Â  Â  Â  Â  const examId = generateUniqueID();
Â  Â  Â  Â  Â  Â  const examData = {
Â  Â  Â  Â  Â  Â  Â  Â  id: examId,
Â  Â  Â  Â  Â  Â  Â  Â  teacherId: window.teacherId,
Â  Â  Â  Â  Â  Â  Â  Â  type: examType,
Â  Â  Â  Â  Â  Â  Â  Â  date: data,
Â  Â  Â  Â  Â  Â  Â  Â  student: { name: nome, surname: cognome, class: classe },
Â  Â  Â  Â  Â  Â  Â  Â  questions: generatedQuestions,
Â  Â  Â  Â  Â  Â  Â  Â  generatedAt: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  correction: { points: 0, grade: 0, oralGrade: 0, comments: {} }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  // 4. Salva su Firestore (max 3 tentativi)
Â  Â  Â  Â  Â  Â  const examDocRef = window.doc(window.getExamCollectionRef(), examId);
Â  Â  Â  Â  Â  Â  let retryCount = 0;
Â  Â  Â  Â  Â  Â  while (retryCount < 3) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await window.setDoc(examDocRef, examData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break; // Successo, esci dal loop
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Errore di salvataggio Firestore, tentativo ${retryCount + 1}:`, error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  retryCount++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (retryCount < 3) await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount) * 1000)); // Exponential backoff
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else throw new Error("Salvataggio fallito dopo 3 tentativi.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 5. Genera il PDF scaricabile (tramite window.print)
Â  Â  Â  Â  Â  Â  generatePrintablePDF(examData, isStudent);

Â  Â  Â  Â  Â  Â  // 6. Aggiorna l'interfaccia utente con il link di correzione
Â  Â  Â  Â  Â  Â  const correctionLink = `${window.location.origin}${window.location.pathname}?examId=${examId}`;
Â  Â  Â  Â  Â  Â  window.addCorrectionLink(examType, examId, nome, cognome, classe, correctionLink);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  window.hideLoading();
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // Aggiorna i container dei link
Â  Â  Â  Â  window.updateLinkContainers = async () => {
Â  Â  Â  Â  Â  Â  if (!window.db || !window.teacherId) return;

Â  Â  Â  Â  Â  Â  const examCollection = window.getExamCollectionRef();
Â  Â  Â  Â  Â  Â  const q = window.query(examCollection, window.where("teacherId", "==", window.teacherId));
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const querySnapshot = await window.getDocs(q);
Â  Â  Â  Â  Â  Â  Â  Â  const examsByType = { 'A': [], 'B': [], 'C': [], 'D': [] };

Â  Â  Â  Â  Â  Â  Â  Â  querySnapshot.forEach((doc) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (examsByType[data.type]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  examsByType[data.type].push(data);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(examsByType).forEach(type => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const containerId = `link-container-${type}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const messageId = `link-message-${type}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const container = document.getElementById(containerId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (examsByType[type].length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(messageId).classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const listHtml = examsByType[type].map(exam => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const link = `${window.location.origin}${window.location.pathname}?examId=${exam.id}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="bg-white p-3 rounded-lg flex justify-between items-center shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium text-gray-800">${exam.student.surname} ${exam.student.name} (${exam.student.class}) - ${exam.date}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="${link}" target="_blank" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition">Correggi Link ğŸ”—</a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = `<h4 class="text-lg font-semibold text-${type === 'A' ? 'red' : type === 'B' ? 'purple' : type === 'C' ? 'teal' : 'yellow'}-600 border-b border-${type === 'A' ? 'red' : type === 'B' ? 'purple' : type === 'C' ? 'teal' : 'yellow'}-300 pb-1">Link di Correzione Generati (Verifica ${type}):</h4>` + listHtml;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(messageId).classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Errore nel caricamento dei link di correzione:", e);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  window.addCorrectionLink = (type, examId, nome, cognome, classe, link) => {
Â  Â  Â  Â  Â  Â  // Funzione di supporto per l'aggiunta dinamica dopo la generazione (senza ricaricare da DB)
Â  Â  Â  Â  Â  Â  const container = document.getElementById(`link-container-${type}`);
Â  Â  Â  Â  Â  Â  document.getElementById(`link-message-${type}`).classList.add('hidden');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const newLinkHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-3 rounded-lg flex justify-between items-center shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium text-gray-800">${cognome} ${nome} (${classe}) - ${new Date().toISOString().split('T')[0]}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="${link}" target="_blank" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition">Correggi Link ğŸ”—</a>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Se il container ha solo l'header, aggiungi subito il link. Altrimenti, aggiungilo in testa.
Â  Â  Â  Â  Â  Â  const header = container.querySelector('h4');
Â  Â  Â  Â  Â  Â  if (header && container.children.length > 1) {
Â  Â  Â  Â  Â  Â  Â  Â  header.insertAdjacentHTML('afterend', newLinkHtml);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = `<h4 class="text-lg font-semibold text-${type === 'A' ? 'red' : type === 'B' ? 'purple' : type === 'C' ? 'teal' : 'yellow'}-600 border-b border-${type === 'A' ? 'red' : type === 'B' ? 'purple' : type === 'C' ? 'teal' : 'yellow'}-300 pb-1">Link di Correzione Generati (Verifica ${type}):</h4>` + newLinkHtml;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // -------------------------------------------------------------------------
Â  Â  Â  Â  // LOGICA DI CORREZIONE
Â  Â  Â  Â  // -------------------------------------------------------------------------

Â  Â  Â  Â  window.loadCorrectionView = async (examId) => {
Â  Â  Â  Â  Â  Â  document.getElementById('main-view').classList.add('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('correction-view').classList.remove('hidden');

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const examDocRef = window.doc(window.getExamCollectionRef(), examId);
Â  Â  Â  Â  Â  Â  Â  Â  const docSnap = await window.getDoc(examDocRef);

Â  Â  Â  Â  Â  Â  Â  Â  if (!docSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Verifica non trovata con ID:", examId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.hideLoading();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  currentExamData = docSnap.data();

Â  Â  Â  Â  Â  Â  Â  Â  // Popola l'intestazione
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('corr-student-name').textContent = `${currentExamData.student.name} ${currentExamData.student.surname}`;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('corr-class').textContent = currentExamData.student.class;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('corr-title').textContent = `Tipo ${currentExamData.type} - Data ${currentExamData.date}`;

Â  Â  Â  Â  Â  Â  Â  Â  // Inizializza i punteggi
Â  Â  Â  Â  Â  Â  Â  Â  const correction = currentExamData.correction;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('voto-orale').value = correction.oralGrade || 6.0;

Â  Â  Â  Â  Â  Â  Â  Â  // Popola il form di correzione
Â  Â  Â  Â  Â  Â  Â  Â  updateCorrectionForm(currentExamData);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Aggiorna il voto finale iniziale
Â  Â  Â  Â  Â  Â  Â  Â  updateFinalGrade();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  window.hideLoading();

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Errore nel caricamento della vista di correzione:", error);
Â  Â  Â  Â  Â  Â  Â  Â  window.hideLoading();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  function updateCorrectionForm(examData) {
Â  Â  Â  Â  Â  Â  const form = document.getElementById('correction-form');
Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â  let currentPoints = 0;

Â  Â  Â  Â  Â  Â  examData.questions.forEach((q, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const qNum = index + 1;
Â  Â  Â  Â  Â  Â  Â  Â  const qText = q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
Â  Â  Â  Â  Â  Â  Â  Â  const isCorrect = examData.correction.comments[q.id]?.isCorrect || false;
Â  Â  Â  Â  Â  Â  Â  Â  const comment = examData.correction.comments[q.id]?.comment || '';

Â  Â  Â  Â  Â  Â  Â  Â  if (isCorrect) currentPoints++;

Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-5 border-2 ${isCorrect ? 'border-green-400 bg-green-50' : 'border-gray-200 bg-white'} rounded-xl shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-xl font-bold text-gray-800 mb-3">${qNum}. ${qText}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-semibold text-green-700 p-2 bg-green-100 rounded-lg code-font">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  SOLUZIONE CORRETTA: 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-extrabold text-green-900 ml-2">${q.correct}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-4 mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="flex items-center text-lg font-medium text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="${q.id}-check" class="h-6 w-6 text-indigo-600 rounded" ${isCorrect ? 'checked' : ''} onchange="handleCheck('${q.id}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Punti assegnati (1)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="${q.id}-comment" placeholder="Aggiungi un commento sulla risposta dell'alunno..." class="mt-3 p-3 border border-gray-300 rounded-lg w-full resize-y min-h-[80px] focus:ring-indigo-500 focus:border-indigo-500 text-sm">${comment}</textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  form.innerHTML = html;
Â  Â  Â  Â  Â  Â  document.getElementById('corr-points').textContent = currentPoints;
Â  Â  Â  Â  }

Â  Â  Â  Â  window.handleCheck = (qId) => {
Â  Â  Â  Â  Â  Â  const checkbox = document.getElementById(`${qId}-check`);
Â  Â  Â  Â  Â  Â  const newStatus = checkbox.checked;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Aggiorna i punti totali
Â  Â  Â  Â  Â  Â  let currentPoints = parseInt(document.getElementById('corr-points').textContent);
Â  Â  Â  Â  Â  Â  currentPoints += newStatus ? 1 : -1;
Â  Â  Â  Â  Â  Â  document.getElementById('corr-points').textContent = currentPoints;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Aggiorna l'UI del box
Â  Â  Â  Â  Â  Â  const parentDiv = checkbox.closest('div.p-5');
Â  Â  Â  Â  Â  Â  if (newStatus) {
Â  Â  Â  Â  Â  Â  Â  Â  parentDiv.classList.add('border-green-400', 'bg-green-50');
Â  Â  Â  Â  Â  Â  Â  Â  parentDiv.classList.remove('border-gray-200', 'bg-white');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  parentDiv.classList.remove('border-green-400', 'bg-green-50');
Â  Â  Â  Â  Â  Â  Â  Â  parentDiv.classList.add('border-gray-200', 'bg-white');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  updateFinalGrade();
Â  Â  Â  Â  };

Â  Â  Â  Â  window.updateFinalGrade = () => {
Â  Â  Â  Â  Â  Â  const points = parseInt(document.getElementById('corr-points').textContent);
Â  Â  Â  Â  Â  Â  const maxPoints = window.MAX_POINTS;
Â  Â  Â  Â  Â  Â  const oralGrade = parseFloat(document.getElementById('voto-orale').value) || 0;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Voto scritto convertito in base 10
Â  Â  Â  Â  Â  Â  const writtenGradeBase10 = (points / maxPoints) * 10;
Â  Â  Â  Â  Â  Â  document.getElementById('voto-scritto-base').textContent = writtenGradeBase10.toFixed(2);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Voto finale (70% scritto, 30% orale)
Â  Â  Â  Â  Â  Â  const finalGrade = (writtenGradeBase10 * 0.7) + (oralGrade * 0.3);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Arrotonda per difetto
Â  Â  Â  Â  Â  Â  document.getElementById('corr-grade-floored').textContent = Math.floor(finalGrade).toString();
Â  Â  Â  Â  };

Â  Â  Â  Â  // Salva e scarica il PDF dei risultati
Â  Â  Â  Â  window.saveAndDownloadResultsPDF = async () => {
Â  Â  Â  Â  Â  Â  if (!currentExamData) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Nessun dato verifica caricato.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  window.showLoading();

Â  Â  Â  Â  Â  Â  // 1. Raccogli i dati di correzione
Â  Â  Â  Â  Â  Â  const correctionData = {
Â  Â  Â  Â  Â  Â  Â  Â  points: parseInt(document.getElementById('corr-points').textContent),
Â  Â  Â  Â  Â  Â  Â  Â  writtenGrade: parseFloat(document.getElementById('voto-scritto-base').textContent),
Â  Â  Â  Â  Â  Â  Â  Â  oralGrade: parseFloat(document.getElementById('voto-orale').value),
Â  Â  Â  Â  Â  Â  Â  Â  finalGrade: Math.floor(parseFloat(document.getElementById('corr-grade-floored').textContent)),
Â  Â  Â  Â  Â  Â  Â  Â  comments: {}
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  currentExamData.questions.forEach(q => {
Â  Â  Â  Â  Â  Â  Â  Â  const check = document.getElementById(`${q.id}-check`).checked;
Â  Â  Â  Â  Â  Â  Â  Â  const comment = document.getElementById(`${q.id}-comment`).value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  correctionData.comments[q.id] = { isCorrect: check, comment: comment };
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Aggiorna i dati nel record di base
Â  Â  Â  Â  Â  Â  currentExamData.correction = correctionData;
Â  Â  Â  Â  Â  Â  currentExamData.correctedAt = new Date().toISOString();

Â  Â  Â  Â  Â  Â  // 2. Salva il record aggiornato su Firestore
Â  Â  Â  Â  Â  Â  const examDocRef = window.doc(window.getExamCollectionRef(), currentExamData.id);
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await window.setDoc(examDocRef, currentExamData);
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Correzione salvata con successo!");
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Errore nel salvataggio della correzione:", e);
Â  Â  Â  Â  Â  Â  Â  Â  window.hideLoading();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 3. Genera e scarica il PDF di riepilogo della correzione
Â  Â  Â  Â  Â  Â  createCorrectionPDF(currentExamData);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  window.hideLoading();
Â  Â  Â  Â  Â  Â  // Opzionale: Torna alla vista principale dopo il salvataggio
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = window.location.origin + window.location.pathname;
Â  Â  Â  Â  Â  Â  }, 1000);

Â  Â  Â  Â  };
Â  Â  Â  Â  
Â  Â  Â  Â  function createCorrectionPDF(examData) {
Â  Â  Â  Â  Â  Â  const correction = examData.correction;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  let html = `
Â  Â  Â  Â  Â  Â  <div class="p-8">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="print-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-2xl font-black text-green-700">RIEPILOGO CORREZIONE VERIFICA</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-700">Prof. Giuseppe Borzumati | Data Correzione: ${new Date().toLocaleDateString('it-IT')} | ID: ${examData.id}</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="my-4 p-3 border-4 border-yellow-500 bg-yellow-100 rounded-lg text-lg font-bold">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>ALUNNO: ${examData.student.surname} ${examData.student.name} (${examData.student.class})</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-2 text-xl font-extrabold text-red-700">VOTO FINALE (Arrotondato): ${correction.finalGrade} / 10</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-base text-gray-800">Punti Ottenuti: ${correction.points} / ${window.MAX_POINTS}</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold text-gray-700 mt-6 mb-3 border-b border-gray-300 pb-1">Commenti e Risultati Dettagliati</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <ol class="list-none p-0" style="counter-reset: question-counter;">
Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  examData.questions.forEach((q, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const qNum = index + 1;
Â  Â  Â  Â  Â  Â  Â  Â  const result = correction.comments[q.id];
Â  Â  Â  Â  Â  Â  Â  Â  const isCorrect = result?.isCorrect;
Â  Â  Â  Â  Â  Â  Â  Â  const status = isCorrect ? 'CORRETTO' : 'ERRATO';
Â  Â  Â  Â  Â  Â  Â  Â  const statusClass = isCorrect ? 'text-green-700' : 'text-red-700';
Â  Â  Â  Â  Â  Â  Â  Â  const commentText = result?.comment || 'Nessun commento lasciato.';

Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li class="question-item" style="border-left: 4px solid ${isCorrect ? '#10b981' : '#ef4444'};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="question-text">${qNum}. ${q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Stato: <span class="font-bold ${statusClass}">${status}</span> | Punteggio: <span class="font-bold ${statusClass}">${isCorrect ? '1' : '0'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-semibold text-gray-800 mt-2">Correzione Docente: <span class="font-normal italic">${commentText}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500 mt-1">Soluzione: ${q.correct}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  </ol>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-8 pt-4 border-t border-gray-300 text-xs text-gray-500 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Riepilogo generato dal sistema Borzumati.
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  const printArea = document.getElementById('print-area');
Â  Â  Â  Â  Â  Â  printArea.innerHTML = html;

Â  Â  Â  Â  Â  Â  // Imposta il titolo per il nome del file PDF
Â  Â  Â  Â  Â  Â  document.title = `Correzione_${examData.student.surname}_${examData.student.class}_${examData.date}_Voto${correction.finalGrade}.pdf`;

Â  Â  Â  Â  Â  Â  printArea.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  window.print();
Â  Â  Â  Â  Â  Â  Â  Â  printArea.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.title = 'Generatore Verifiche Informatica - Borzumati';
Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  }

Â  Â  </script>
</body>
</html>
