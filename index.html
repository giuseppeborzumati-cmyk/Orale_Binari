<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Verifiche Informatica - Borzumati</title>
    <!-- Carica Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .code-font { font-family: 'Roboto Mono', monospace; }
        .code-block { background-color: #1e293b; color: #f8fafc; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; }

        /* Stili per la stampa PDF (ottimizzazione 2 pagine A4) */
        @media print {
            body { font-family: sans-serif !important; font-size: 10pt; background: white !important; }
            body > *:not(.print-container) { display: none !important; }
            .print-container { 
                display: block !important; 
                max-width: none !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                box-shadow: none !important; 
                height: auto;
            }
            @page { margin: 1.5cm 1cm; }
            
            .print-header { border-bottom: 2px solid #6366f1; padding-bottom: 0.5rem; margin-bottom: 1rem; }
            .print-header h1 { font-size: 16pt !important; font-weight: 900; }
            .print-header p { font-size: 10pt !important; color: #374151; }
            
            .question-item { 
                margin-bottom: 1.2rem; 
                page-break-inside: avoid;
                border-left: 4px solid #6366f1;
                padding-left: 0.75rem;
                counter-increment: question-counter;
            }
            .question-item::before {
                content: counter(question-counter) ". ";
                font-weight: bold;
                margin-right: 0.25rem;
                color: #6366f1;
            }
            .question-text { font-weight: 700; color: #1f2937; margin-bottom: 0.3rem; }
            .answer-line { 
                height: 1.2em; 
                display: block; 
                border-bottom: 1px dashed #9ca3af; 
                width: 100%; 
                margin-top: 0.2rem; 
            }
            .solution-box { 
                border: 1px solid #10b981; 
                background-color: #d1fae5; 
                padding: 0.2rem 0.5rem; 
                border-radius: 4px; 
                margin-top: 0.4rem; 
                font-size: 9pt;
                font-family: 'Roboto Mono', monospace;
            }
        }

        /* Stili per i pulsanti animati */
        .action-button { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); font-weight: 700; position: relative; overflow: hidden; }
        .action-button:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
        .action-button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.2); transform: skewX(-20deg); transition: all 0.7s; }
        .action-button:hover::before { left: 100%; }
        .bg-gradient-blue { background-image: linear-gradient(to right, #4c66ff 0%, #00c6ff 100%); }
        .bg-gradient-green { background-image: linear-gradient(to right, #10b981 0%, #1d7c4c 100%); }
    </style>
</head>
<body class="bg-gray-900 min-h-screen p-4 sm:p-8">

    <!-- Area di caricamento -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex items-center justify-center hidden">
        <div class="text-center text-white">
            <svg class="animate-spin h-10 w-10 text-indigo-400 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-semibold">Caricamento dati in corso... (Connessione a Firebase)</p>
        </div>
    </div>
    
    <!-- Sezione Dati Studente/Docente e Introduzione -->
    <div id="main-view" class="w-full max-w-7xl mx-auto bg-white rounded-xl shadow-[0_25px_50px_-12px_rgba(0,0,0,0.5)] p-6 sm:p-12 mb-8 space-y-10">
        <header class="text-center pb-6 border-b-4 border-indigo-500">
            <h1 class="text-4xl sm:text-6xl font-black leading-tight">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-purple-600"> GENERATORE VERIFICHE INFORMATICA </span>
            </h1>
            <p class="text-xl text-gray-700 mt-2">Prof. Giuseppe Borzumati | 11 Domande Miste Pratica + Teoria Semplice</p>
        </header>

        <!-- Dati Studente per la Generazione (Globali) -->
        <div class="bg-indigo-50 p-8 rounded-2xl shadow-inner border border-indigo-200">
            <h2 class="text-2xl font-bold text-indigo-800 mb-5 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 mr-2 text-indigo-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                </svg> 
                Dati Base
                <span id="teacher-id" class="code-font text-xs ml-4 p-1 bg-indigo-200 text-indigo-800 rounded"></span>
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div> <input type="text" id="nome-studente" placeholder="Nome" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
                <div> <input type="text" id="cognome-studente" placeholder="Cognome" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
                <div> <input type="text" id="classe-studente" placeholder="Classe (es. 4B)" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
                <div> <input type="date" id="data-verifica" value="" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
            </div>
            <p class="text-sm text-indigo-600 mt-4 font-semibold">Tutti i campi sono obbligatori per generare il link di correzione.</p>
        </div>

        <!-- Contenitore delle Verifiche (4 Blocchi) -->
        <div class="space-y-12">

            <!-- BLOCCO 1: Verifiche Numeriche PURE -->
            <div id="blocco-verifica-a" class="p-8 bg-red-50 border-t-8 border-t-red-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-red-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">🔢</span> VERIFICA A: Sistemi di Numerazione Base & Operazioni
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Conversione Base (2, 8, 10, 16), Frazioni Binarie, Numeri Romani e Operazioni Binaria. (11 Domande Miste)</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('A', true)"> 📄 Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('A', false)"> 🎓 Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-A" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-red-600 border-b border-red-300 pb-1">Link di Correzione Generati (Verifica A):</h4>
                    <p class="text-sm text-gray-500" id="link-message-A">Nessuna verifica di Tipo A generata.</p>
                </div>
            </div>

            <!-- BLOCCO 2: A + Networking Semplice -->
            <div id="blocco-verifica-b" class="p-8 bg-purple-50 border-t-8 border-t-purple-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-purple-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">🌐</span> VERIFICA B: Sistemi di Numerazione + Networking Semplice
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Contenuti della Verifica A + Subnetting Semplice (CIDR, Network/Broadcast ID, Maschera). (11 Domande Miste)</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('B', true)"> 📄 Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('B', false)"> 🎓 Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-B" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-purple-600 border-b border-purple-300 pb-1">Link di Correzione Generati (Verifica B):</h4>
                    <p class="text-sm text-gray-500" id="link-message-B">Nessuna verifica di Tipo B generata.</p>
                </div>
            </div>

            <!-- BLOCCO 3: A + Networking Semplice (uguale a B per bilanciamento) -->
            <div id="blocco-verifica-c" class="p-8 bg-teal-50 border-t-8 border-t-teal-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-teal-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">🔬</span> VERIFICA C: Sistemi di Numerazione + Networking Semplice
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Contenuti della Verifica A + Subnetting Semplice (CIDR, Network/Broadcast ID, Maschera). (11 Domande Miste) - Ideale per un'alternativa alla B.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('C', true)"> 📄 Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('C', false)"> 🎓 Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-C" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-teal-600 border-b border-teal-300 pb-1">Link di Correzione Generati (Verifica C):</h4>
                    <p class="text-sm text-gray-500" id="link-message-C">Nessuna verifica di Tipo C generata.</p>
                </div>
            </div>
            
            <!-- BLOCCO 4: Riepilogo Completo e Problemi Critici (Verifica D) -->
            <div id="blocco-verifica-d" class="p-8 bg-yellow-50 border-t-8 border-t-yellow-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-yellow-800 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">⭐</span> VERIFICA D: Riepilogo Completo (Complemento a 2, Floating Point, IP Avanzato)
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Mix di tutti gli argomenti avanzati: Complemento a Due, Floating Point e Subnetting complesso (VLSM/CIDR). (11 Domande Miste)</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('D', true)"> 📄 Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('D', false)"> 🎓 Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-D" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-yellow-600 border-b border-yellow-300 pb-1">Link di Correzione Generati (Verifica D):</h4>
                    <p class="text-sm text-gray-500" id="link-message-D">Nessuna verifica di Tipo D generata.</p>
                </div>
            </div>

        </div>

        <footer class="text-center pt-8 text-gray-500 text-sm border-t border-gray-200">
            <p>Sistema di Generazione Verifiche v5.2 | Per l'Insegnante Giuseppe Borzumati. Assicurati che il pop-up del browser sia consentito per scaricare il PDF.</p>
        </footer>
    </div>

    <!-- VISTA DI CORREZIONE (Caricata tramite link condivisibile) -->
    <div id="correction-view" class="hidden w-full max-w-5xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10 mb-8 space-y-8">
        <header class="text-center pb-4 border-b-4 border-green-500">
            <h1 class="text-4xl font-extrabold text-green-700 leading-tight">Griglia di Correzione Interattiva</h1>
            <p class="text-lg text-gray-600 mt-1">
                Studente: <span id="corr-student-name" class="font-extrabold text-indigo-600"></span> - 
                Classe: <span id="corr-class" class="font-extrabold text-indigo-600"></span> - 
                Verifica <span id="corr-title" class="font-bold"></span>
            </p>
        </header>

        <!-- Tabella Punteggio e Voto -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 bg-yellow-50 p-6 rounded-xl border-2 border-yellow-300 shadow-lg">
            <div class="col-span-1 lg:col-span-3">
                <h2 class="text-2xl font-bold text-yellow-800 mb-2 border-b border-yellow-400 pb-1">Valutazione</h2>
            </div>
            
            <div class="bg-blue-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-blue-800">Punti Ottenuti:</p>
                <p class="text-4xl font-extrabold text-blue-600 mt-1"><span id="corr-points">0</span> / <span id="corr-max-points">11</span></p>
            </div>
            
            <div class="bg-purple-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-purple-800">Voto Orale (Base 10):</p>
                <input type="number" id="voto-orale" min="0" max="10" step="0.1" value="6.0" onchange="updateFinalGrade()" class="p-2 border-2 border-purple-500 rounded-lg w-full mt-1 text-xl font-bold">
            </div>
            
            <div class="bg-red-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-red-800">Voto Finale (Arrotondato per Difetto):</p>
                <p class="text-4xl font-extrabold text-red-600 mt-1"><span id="corr-grade-floored">0</span> / 10</p>
            </div>
            
            <div class="col-span-1 lg:col-span-3 bg-gray-100 p-4 rounded-lg border border-gray-300" id="conversion-explanation">
                <p class="text-sm font-bold text-gray-700">Formula di Calcolo:</p>
                <code class="code-font text-xs block mt-1 p-2 bg-white rounded"> Voto Scritto Base 10 = (Punti Ottenuti / 11) * 10 = <span id="voto-scritto-base">0.00</span> </code>
                <code class="code-font text-xs block mt-1 p-2 bg-white rounded"> Voto Finale = (Voto Scritto * 0.7) + (Voto Orale * 0.3) </code>
            </div>
        </div>

        <!-- Esercizi con Correzione -->
        <div id="correction-form" class="space-y-6"> 
            <!-- Gli esercizi e i campi di input saranno popolati qui dal JS -->
        </div>

        <button class="action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-lg mt-8 w-full" onclick="saveAndDownloadResultsPDF()"> Salva Risultati e Scarica PDF dei Commenti </button>
        <button class="action-button bg-gray-400 hover:bg-gray-500 text-gray-900 py-3 px-6 rounded-lg text-lg w-full" onclick="window.location.href = window.location.origin + window.location.pathname"> Torna alla Generazione Verifiche </button>
    </div>

    <!-- Contenitore Nascosto per la Stampa PDF (Stile ottimizzato per PDF) -->
    <div id="print-area" class="print-container hidden"></div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Imposta il livello di log per debug
        setLogLevel('Debug');

        // Variabili Globali del Modulo
        window.db = null;
        window.auth = null;
        window.teacherId = null;
        window.MAX_POINTS = 11; // Punti massimi per la verifica (1 punto per domanda)

        // Configurazione Firebase: Usa le variabili globali se disponibili, altrimenti il fallback fornito dall'utente.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDtruKdnoFjMqob-1zf-Zw0hXn8j_YwVio",
            authDomain: "verifichenumeribinari.firebaseapp.com",
            projectId: "verifichenumeribinari",
            storageBucket: "verifichenumeribinari.firebasestorage.app",
            messagingSenderId: "648812468179",
            appId: "1:648812468179:web:1a0e2d65cb1aae28e60126",
            measurementId: "G-K5SL1808G4"
        };
        
        // Variabile ID App (usata per il path Firestore)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Funzione di Inizializzazione Firebase
        async function initializeFirebase() {
            try {
                // 1. Inizializzazione App
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // 2. Autenticazione Anonima o con Token
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }
                
                window.teacherId = window.auth.currentUser.uid;
                
                // 3. Nascondi Overlay e Avvia l'app
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('teacher-id').textContent = `Docente ID: ${window.teacherId.substring(0, 8)}...`;

                // 4. Carica i link di correzione esistenti
                await window.updateLinkContainers();

                // 5. Verifica se è una vista di correzione
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('examId');
                if (examId) {
                    window.showLoading();
                    await window.loadCorrectionView(examId);
                } else {
                    window.showMainView();
                }

            } catch (error) {
                console.error("Errore fatale nell'inizializzazione di Firebase e Auth:", error);
                // Sostituisci alert() con un messaggio sulla console o un modale custom
                const errorMsg = "Errore di connessione al database. Controlla la console per i dettagli. (ID App: " + appId + ")";
                console.log(errorMsg);
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        // Metodo per ottenere il path corretto per Firestore (pubblico)
        window.getExamCollectionRef = () => {
             return collection(window.db, "artifacts", appId, "public", "data", "exams");
        };

        // ESPORTA LE FUNZIONI DI FIRESTORE NEL CONTESTO GLOBALE
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.doc = doc;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;

        // Esegui l'inizializzazione al caricamento
        window.addEventListener('load', () => {
            initializeFirebase();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('data-verifica').value = today;
            document.getElementById('corr-max-points').textContent = window.MAX_POINTS;
        });
    </script>
    
    <script>
        // -------------------------------------------------------------------------
        // LOGICA DI VISTA E UTILITY
        // -------------------------------------------------------------------------

        let currentExamData = null; // Dati della verifica attualmente in correzione
        
        window.showLoading = () => document.getElementById('loading-overlay').classList.remove('hidden');
        window.hideLoading = () => document.getElementById('loading-overlay').classList.add('hidden');

        // Navigazione tra le viste
        window.showMainView = () => {
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('correction-view').classList.add('hidden');
            window.hideLoading();
        };

        // Funzione per generare un ID unico
        const generateUniqueID = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 5);

        // Funzione per pulire e standardizzare le risposte (tolleranza)
        const cleanAnswer = (s) => s.toString()
            .trim()
            .toUpperCase()
            .replace(/[^A-Z0-9\.\/\;\-\+\s]/g, '') // Rimuove caratteri non validi
            .replace(/\s+/g, ''); // Rimuove tutti gli spazi

        // -------------------------------------------------------------------------
        // FUNZIONI NUMERICHE DI CALCOLO (CRITICHE)
        // -------------------------------------------------------------------------

        // Genera un numero intero casuale in un range (incluso)
        const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        // Conversione da base B a Decimale
        function convertToBase10(numStr, base) {
            return parseInt(numStr, base);
        }

        // Conversione Decimale a Base B
        function convertFromBase10(numDec, base) {
            return numDec.toString(base).toUpperCase();
        }

        // Funzione per generare un numero binario con parte frazionaria
        function generateBinaryFractional() {
            const integerPart = randInt(10, 30);
            let binFractional = '';
            let fractionalValue = 0;

            // Assicurati che non ci siano troppi zeri iniziali o finali inutili
            for (let i = 0; i < 4; i++) {
                const bit = randInt(0, 1);
                binFractional += bit;
                fractionalValue += bit * Math.pow(2, -(i + 1));
            }

            const decimalValue = integerPart + fractionalValue;
            const binaryValue = integerPart.toString(2) + '.' + binFractional.replace(/0+$/, ''); // Rimuove gli zeri finali
            
            return { decimal: parseFloat(decimalValue.toFixed(4)), binary: binaryValue };
        }

        // Funzione per calcolare il Complemento a Due (8 bit)
        function toTwosComplement(num) {
            if (num < -128 || num > 127) return 'OUT_OF_RANGE';
            if (num >= 0) {
                return num.toString(2).padStart(8, '0');
            }
            
            const absNum = Math.abs(num);
            // Converti in binario positivo a 8 bit
            let binPos = absNum.toString(2).padStart(8, '0');
            
            // Inverti i bit
            let inverted = [...binPos].map(b => b === '0' ? '1' : '0').join('');
            
            // Aggiungi 1 (in binario)
            let sumBin = (parseInt(inverted, 2) + 1).toString(2);
            return sumBin.padStart(8, '0').slice(-8);
        }

        // Conversione Decimale a Romano (fino a 999)
        function decToRoman(num) {
            if (num > 999) return "ERR_MAX";
            const map = { 1000: 'M', 900: 'CM', 500: 'D', 400: 'CD', 100: 'C', 90: 'XC', 50: 'L', 40: 'XL', 10: 'X', 9: 'IX', 5: 'V', 4: 'IV', 1: 'I' };
            let roman = '';
            for (let i of Object.keys(map).map(Number).sort((a, b) => b - a)) {
                while (num >= i) {
                    roman += map[i];
                    num -= i;
                }
            }
            return roman;
        }

        // Calcolo Notazione Scientifica Binaria (Floating Point Semplificato - Mantissa 10 bit, Esponente offset 7)
        function calculateFloatingPoint(dec) {
            let sign = dec >= 0 ? 0 : 1;
            let num = Math.abs(dec);
            if (num === 0) return { sign, exponent: '0000000', mantissa: '0'.repeat(10), full: '0' };

            const integerPart = Math.floor(num);
            let fractionalPart = num - integerPart;
            
            let binary = integerPart.toString(2);
            let fracBin = '';

            let tempFrac = fractionalPart;
            for (let i = 0; i < 15; i++) {
                tempFrac *= 2;
                let bit = Math.floor(tempFrac);
                fracBin += bit;
                tempFrac -= bit;
            }

            binary += '.' + fracBin;

            // Trova la posizione del primo '1' per la normalizzazione
            let firstOneIndex = binary.indexOf('1');
            let dotIndex = binary.indexOf('.');
            let E; // Esponente puro (spostamento)

            if (integerPart > 0) {
                E = dotIndex - firstOneIndex - 1;
            } else { // < 1
                E = dotIndex - firstOneIndex;
            }

            // Esponente biased (offset 7)
            let biasedE = E + 7;
            if (biasedE < 0 || biasedE > 15) return { sign, exponent: 'RANGE_ERR', mantissa: 'RANGE_ERR' };
            const expBin = biasedE.toString(2).padStart(4, '0'); // 4 bit per l'esponente

            // Mantissa (rimuovi 1 implicito e prendi 10 bit)
            let normalized = binary.replace('.', '');
            let mantissaStart = normalized.substring(firstOneIndex + 1);
            
            const mantissa = mantissaStart.padEnd(10, '0').substring(0, 10);
            const full = `${sign}${expBin}${mantissa}`;

            return { sign, exponent: expBin, mantissa, full };
        }

        // Funzione per calcolare ID Rete/Broadcast/Maschera
        function calculateNetworkIDs(ip, cidr) {
            const mask = parseInt(cidr, 10);
            const octets = ip.split('.').map(o => parseInt(o));
            const ipBin = octets.map(o => o.toString(2).padStart(8, '0')).join('');
            
            const networkPart = ipBin.substring(0, mask);
            
            // Network ID (host part = 0)
            const netIDBinary = networkPart.padEnd(32, '0');
            let networkID = [];
            for (let n = 0; n < 4; n++) {
                networkID.push(parseInt(netIDBinary.substring(n * 8, n * 8 + 8), 2));
            }
            const netID = networkID.join('.');

            // Broadcast ID (host part = 1)
            const hostPart = '1'.repeat(32 - mask);
            const broadcastBinary = networkPart + hostPart;
            let broadcastID = [];
            for (let n = 0; n < 4; n++) {
                broadcastID.push(parseInt(broadcastBinary.substring(n * 8, n * 8 + 8), 2));
            }
            const bcastID = broadcastID.join('.');
            
            // Maschera decimale
            const maskBin = '1'.repeat(mask).padEnd(32, '0');
            let maskDec = [];
            for (let n = 0; n < 4; n++) {
                maskDec.push(parseInt(maskBin.substring(n * 8, n * 8 + 8), 2));
            }
            const subnetMask = maskDec.join('.');

            return { network: netID, broadcast: bcastID, mask: subnetMask };
        }
        
        // -------------------------------------------------------------------------
        // POOL DI GENERATORI DI DOMANDE MISTE (11)
        // -------------------------------------------------------------------------

        function generateMixedQuestion(qNum, examType) {
            let question = {};
            let num1, num2, ip, cidr, result, type;
            const isAdvanced = examType === 'D';
            const isNetworking = examType === 'B' || examType === 'C' || examType === 'D';

            switch (qNum) {
                // Q1: Decimale -> Base X (2, 8, 16) + Teoria Semplice
                case 1:
                    num1 = randInt(100, 255);
                    const targetBase = randInt(0, 1) === 0 ? 2 : 16;
                    result = convertFromBase10(num1, targetBase);
                    question.text = `**PARTE PRATICA:** Converti il numero Decimale **${num1}** in **Base ${targetBase}**.
                        **PARTE TEORICA:** Dato un numero di 8 bit, qual è l'**intervallo massimo** di valori che può rappresentare se si considerano solo numeri **senza segno** (unsigned)?`;
                    question.correct = result;
                    break;

                // Q2: Base X -> Decimale + Teoria (Posizione)
                case 2:
                    num1 = randInt(100, 300);
                    const inputBase = randInt(0, 1) === 0 ? 8 : 16;
                    const inputNum = convertFromBase10(num1, inputBase);
                    result = num1.toString();
                    question.text = `**PARTE PRATICA:** Converti il numero **${inputNum} (Base ${inputBase})** in **Decimale**.
                        **PARTE TEORICA:** Spiega il concetto di **sistema di numerazione posizionale** (come il Binario e il Decimale), e come questo differisce dal sistema Romano.`;
                    question.correct = result;
                    break;

                // Q3: Conversione Base 16 a Binario / Base 8 a Binario (Diretta)
                case 3:
                    num1 = randInt(500, 1500);
                    const isHex = randInt(0, 1) === 0;
                    const startBase = isHex ? 16 : 8;
                    const inputNum3 = convertFromBase10(num1, startBase).slice(-3);
                    result = convertToBase10(inputNum3, startBase).toString(2);
                    question.text = `**PARTE PRATICA:** Converti il numero **${inputNum3} (Base ${startBase})** in **Binario**.
                        **PARTE TEORICA:** Spiega perché la conversione da Base ${startBase} a Binario e viceversa è considerata una **conversione diretta** o *shortcut*, e qual è il fattore chiave (potenza di due) che la rende tale.`;
                    question.correct = result;
                    break;

                // Q4: Addizione Binaria (semplice, 8 bit)
                case 4:
                    num1 = randInt(20, 50);
                    num2 = randInt(10, 40);
                    const bin1 = num1.toString(2).padStart(8, '0');
                    const bin2 = num2.toString(2).padStart(8, '0');
                    result = (num1 + num2).toString(2).padStart(8, '0').slice(-8);
                    question.text = `**PARTE PRATICA:** Esegui l'addizione binaria: **$${bin1} + ${bin2}$** (risultato in binario, 8 bit).
                        **PARTE TEORICA:** Cos'è il **Carry-out** (riporto finale) nell'addizione binaria? Spiega in breve la sua importanza nel contesto di un'architettura di sistema a $N$ bit.`;
                    question.correct = result;
                    break;

                // Q5: Frazione Binaria -> Decimale + Teoria (Errore)
                case 5:
                    const fracNum = generateBinaryFractional();
                    result = fracNum.decimal.toFixed(3);
                    question.text = `**PARTE PRATICA:** Dato il numero Binario con la virgola **${fracNum.binary}**, calcola il suo equivalente in Base **DECIMALE** (risultato con 3 cifre decimali, separatore punto).
                        **PARTE TEORICA:** Descrivi il concetto di **errore di rappresentazione** nelle frazioni binarie. Fai l'esempio di $0.1_{10}$ spiegando perché è un problema comune.`;
                    question.correct = result;
                    break;

                // Q6: Complemento a Due (Solo Avanzato) / Networking (Base)
                case 6:
                    if (isAdvanced) {
                        // D: Complemento a Due (8 bit)
                        num1 = randInt(-100, -1);
                        result = toTwosComplement(num1);
                        question.text = `**PARTE PRATICA:** Converti il numero Decimale **${num1}** nel suo equivalente in **Complemento a Due** (8 bit).
                            **PARTE TEORICA:** Qual è il vantaggio principale dell'utilizzo del Complemento a Due (C2) nei sistemi di calcolo per rappresentare i numeri negativi?`;
                    } else if (isNetworking) {
                        // B/C: Maschera da CIDR
                        cidr = randInt(20, 29);
                        ip = `192.168.${randInt(1, 254)}.${randInt(1, 254)}`; // IP di esempio
                        result = calculateNetworkIDs(ip, cidr).mask;
                        question.text = `**PARTE PRATICA:** Data una notazione CIDR di **/${cidr}**, scrivi la corrispondente **Subnet Mask** in notazione decimale puntata.
                            **PARTE TEORICA:** Spiega la funzione principale della **Subnet Mask** in una rete IP.`;
                    } else {
                        // A: Decimale -> Romani
                        num1 = randInt(100, 999);
                        result = decToRoman(num1);
                        question.text = `**PARTE PRATICA:** Converti il numero Decimale **${num1}** nel suo equivalente in **Numeri Romani**.
                            **PARTE TEORICA:** Qual è la limitazione più grande dei Numeri Romani rispetto al sistema Decimale, e perché è cruciale per il calcolo?`;
                    }
                    break;

                // Q7: Floating Point / Networking (Net ID) / Base Mista
                case 7:
                    if (isAdvanced) {
                        // D: Floating Point (Semplificato 15 bit)
                        num1 = randInt(3, 10) + (randInt(1, 9) / 10);
                        const fpResult = calculateFloatingPoint(num1);
                        result = fpResult.full; // Segno + Esponente (4 bit) + Mantissa (10 bit)
                        question.text = `**PARTE PRATICA:** Applica il formato Floating Point Semplificato (Segno 1, Esp. Bias 7 con 4 bit, Mantissa 10 bit) al numero Decimale **${num1}**. Risposta: **Segno+Esp+Mantissa**.
                            **PARTE TEORICA:** Spiega brevemente il ruolo della **Mantissa** e dell'**Esponente** in un numero Floating Point.`;
                    } else if (isNetworking) {
                        // B/C: Network ID da IP/Mask
                        cidr = randInt(20, 29);
                        ip = `192.168.${randInt(1, 254)}.${randInt(1, 254)}`;
                        result = calculateNetworkIDs(ip, cidr).network;
                        question.text = `**PARTE PRATICA:** Dato l'indirizzo IP **${ip}/${cidr}**, calcola l'**Indirizzo di Rete (Network ID)** in notazione decimale puntata.
                            **PARTE TEORICA:** Spiega a cosa serve l'**Indirizzo di Rete** e in che modo si differenzia da un indirizzo host (come un PC o un router).`;
                    } else {
                        // A: Base Mista (Decimale intermedio)
                        num1 = randInt(50, 150);
                        const input8 = num1.toString(8);
                        result = num1.toString(16).toUpperCase();
                        question.text = `**PARTE PRATICA:** Converti il numero **${input8} (Base 8)** in **Esadecimale (Base 16)**.
                            **PARTE TEORICA:** Descrivi il processo di conversione da Base 8 a Base 16 passando per il Binario. Qual è il vantaggio di usare questo metodo?`;
                    }
                    break;

                // Q8: Base Sconosciuta / CIDR -> Hosts / Floating Point
                case 8:
                    if (isAdvanced) {
                        // D: Calcola Host da CIDR (Avanzato)
                        cidr = randInt(22, 29);
                        result = (Math.pow(2, 32 - cidr) - 2).toString();
                        question.text = `**PARTE PRATICA:** Data la notazione CIDR **/${cidr}**, quanti **Indirizzi Host** utilizzabili (esclusi Network e Broadcast) ci sono in questa subnet?
                            **PARTE TEORICA:** Spiega il concetto di **VLSM (Variable Length Subnet Masking)** in poche parole. Perché è importante per l'efficienza degli indirizzi IP?`;
                    } else if (isNetworking) {
                        // B/C: CIDR -> Hosts (Semplice)
                        cidr = randInt(25, 29);
                        result = (Math.pow(2, 32 - cidr) - 2).toString();
                        question.text = `**PARTE PRATICA:** Data la notazione CIDR **/${cidr}**, quanti **Indirizzi Host** utilizzabili (esclusi Network e Broadcast) ci sono in questa subnet?
                            **PARTE TEORICA:** A cosa serve l'**ARP (Address Resolution Protocol)**? Spiega in breve il suo ruolo nella comunicazione LAN.`;
                    } else {
                        // A: Identificazione Base Sconosciuta
                        num1 = randInt(150, 300);
                        const unknownBase = randInt(3, 7);
                        const inputNum8 = num1.toString(unknownBase);
                        result = unknownBase.toString();
                        question.text = `**PARTE PRATICA:** Il numero **${inputNum8}** equivale a $100_{10}$. Qual è la **Base $X$** in cui è espresso il numero ${inputNum8}?
                            **PARTE TEORICA:** Se la base di un sistema di numerazione è $B$, quali cifre (simboli) può contenere? (Fornisci la formula generale).`;
                    }
                    break;

                // Q9: Indirizzo IP Broadcast ID / Teoria: Octet
                case 9:
                    cidr = randInt(25, 29);
                    ip = `192.168.${randInt(1, 254)}.${randInt(1, 254)}`;
                    result = calculateNetworkIDs(ip, cidr).broadcast;
                    question.text = `**PARTE PRATICA:** Dato l'indirizzo IP **${ip}/${cidr}**, calcola l'**Indirizzo di Broadcast** in notazione decimale puntata.
                        **PARTE TEORICA:** Un indirizzo IP è formato da quattro ottetti (octet), come in $192.168.1.25$. Cosa significa la parola **octet** in questo contesto, e qual è il suo valore massimo in base 10?`;
                    question.correct = result;
                    break;

                // Q10: Conversione Decimale 28-10-16 / Teoria: Sottrazione C2
                case 10:
                    num1 = randInt(10, 50);
                    const num2_2 = randInt(10, 50);
                    result = convertFromBase10(num1, 16).toUpperCase();
                    question.text = `**PARTE PRATICA:** Dato il numero Decimale **$${num1}$**, convertilo in **Esadecimale**.
                        **PARTE TEORICA:** Per effettuare l'operazione di **sottrazione** in un calcolatore (es. $${num2_2} - ${num1}$), si può usare il Complemento a Due. Spiega in breve come viene trasformata l'operazione di sottrazione in una semplice operazione di somma.`;
                    question.correct = result;
                    break;

                // Q11: Decimale -> Hex (indirizzi) / Teoria: Gateway
                case 11:
                    num1 = randInt(10, 255);
                    num2 = randInt(10, 255);
                    result = convertFromBase10(num1, 16).toUpperCase() + convertFromBase10(num2, 16).toUpperCase();
                    question.text = `**PARTE PRATICA:** Converti gli ottetti Decimale **${num1}** e **${num2}** nel loro equivalente **Esadecimale** (concatenati).
                        **PARTE TEORICA:** Cos'è il **Gateway Predefinito** (Default Gateway) in una rete locale? Spiega in che modo è essenziale per la navigazione internet.`;
                    question.correct = result;
                    break;

                default:
                    question.text = 'DOMANDA NON ASSEGNATA - Errore di generazione.';
                    question.correct = 'ERRORE';
            }
            question.id = `q${qNum}`;
            return question;
        }

        // -------------------------------------------------------------------------
        // LOGICA DI GENERAZIONE, STAMPA PDF E SALVATAGGIO
        // -------------------------------------------------------------------------

        // Funzione di generazione del contenuto HTML ottimizzato per la stampa
        function createPrintableHtml(examData, isStudent) {
            const isDocente = !isStudent;
            let html = `
            <div class="p-8">
                <div class="print-header">
                    <h1 class="text-2xl font-black text-indigo-700">VERIFICA DI INFORMATICA - ${examData.type} (${isDocente ? 'DOCENTE - SOLUZIONI' : 'ALUNNO'})</h1>
                    <p class="text-sm text-gray-700">Prof. Giuseppe Borzumati | Data: ${examData.date} | ID Univoco: ${examData.id}</p>
                    <p class="text-sm text-gray-700">Argomenti: Sistemi di Numerazione & Networking (Livello ${examData.type})</p>
                </div>
                <div class="my-4 p-3 border border-gray-300 rounded-lg">
                    <p class="text-lg font-bold">Alunno: ${examData.student.name} ${examData.student.surname} | Classe: ${examData.student.class}</p>
                    <p class="text-xs mt-1">ISTRUZIONI: Rispondi a tutte le 11 domande. La prima parte è pratica (calcolo), la seconda è teorica (spiegazione breve).</p>
                </div>
                <ol class="list-none p-0" style="counter-reset: question-counter;">
        `;

            examData.questions.forEach((q, index) => {
                const qText = q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Conversione Markdown in HTML
                const solutionHtml = isDocente 
                    ? `<div class="solution-box">**SOLUZIONE:** ${q.correct}</div>`
                    : `<div class="mt-4"><span class="answer-line"></span><span class="answer-line"></span></div>`; // Linee vuote per l'alunno

                html += `
                    <li class="question-item">
                        <div class="question-text">${qText}</div>
                        ${solutionHtml}
                    </li>
                `;
            });

            html += `
                </ol>
                <div class="mt-8 pt-4 border-t border-gray-300 text-xs text-gray-500 text-center">
                    Generato con il sistema di Borzumati | Non conservare la copia PDF sul database.
                </div>
            </div>
            `;

            return html;
        }
        
        // Funzione che gestisce la stampa del PDF (trigger nativo di download)
        function generatePrintablePDF(examData, isStudent) {
            const htmlContent = createPrintableHtml(examData, isStudent);
            
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = htmlContent;

            // Imposta il titolo della finestra per il nome del file PDF scaricato
            const fileSuffix = isStudent ? 'ALUNNO' : 'DOCENTE_SOLUZIONI';
            document.title = `Verifica_${examData.student.surname}_${examData.student.class}_${examData.type}_${fileSuffix}_${examData.date}.pdf`;

            printArea.classList.remove('hidden');
            
            // Utilizza setTimeout per garantire che il DOM sia aggiornato prima della stampa
            setTimeout(() => {
                window.print();
                printArea.classList.add('hidden');
                // Ripristina il titolo
                document.title = 'Generatore Verifiche Informatica - Borzumati';
            }, 100);
        }

        // Funzione principale chiamata dai bottoni
        async function handleGeneration(examType, isStudent) {
            if (!window.db || !window.teacherId) {
                console.error("Firebase non inizializzato o utente non autenticato.");
                return;
            }

            // 1. Recupera i dati di base
            const nome = document.getElementById('nome-studente').value.trim();
            const cognome = document.getElementById('cognome-studente').value.trim();
            const classe = document.getElementById('classe-studente').value.trim();
            const data = document.getElementById('data-verifica').value;

            if (!nome || !cognome || !classe || !data) {
                console.log("Per favore, compila tutti i campi (Nome, Cognome, Classe, Data) prima di generare.");
                return;
            }

            window.showLoading();

            // 2. Genera le 11 domande
            const generatedQuestions = [];
            for (let i = 1; i <= window.MAX_POINTS; i++) {
                generatedQuestions.push(generateMixedQuestion(i, examType));
            }

            // 3. Crea il record della verifica
            const examId = generateUniqueID();
            const examData = {
                id: examId,
                teacherId: window.teacherId,
                type: examType,
                date: data,
                student: { name: nome, surname: cognome, class: classe },
                questions: generatedQuestions,
                generatedAt: new Date().toISOString(),
                correction: { points: 0, grade: 0, oralGrade: 0, comments: {} }
            };

            // 4. Salva su Firestore (max 3 tentativi)
            const examDocRef = window.doc(window.getExamCollectionRef(), examId);
            let retryCount = 0;
            while (retryCount < 3) {
                try {
                    await window.setDoc(examDocRef, examData);
                    break; // Successo, esci dal loop
                } catch (error) {
                    console.warn(`Errore di salvataggio Firestore, tentativo ${retryCount + 1}:`, error);
                    retryCount++;
                    if (retryCount < 3) await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount) * 1000)); // Exponential backoff
                    else throw new Error("Salvataggio fallito dopo 3 tentativi.");
                }
            }

            // 5. Genera il PDF scaricabile (tramite window.print)
            generatePrintablePDF(examData, isStudent);

            // 6. Aggiorna l'interfaccia utente con il link di correzione
            const correctionLink = `${window.location.origin}${window.location.pathname}?examId=${examId}`;
            window.addCorrectionLink(examType, examId, nome, cognome, classe, correctionLink);
            
            window.hideLoading();
        }
        
        // Aggiorna i container dei link
        window.updateLinkContainers = async () => {
            if (!window.db || !window.teacherId) return;

            const examCollection = window.getExamCollectionRef();
            const q = window.query(examCollection, window.where("teacherId", "==", window.teacherId));
            
            try {
                const querySnapshot = await window.getDocs(q);
                const examsByType = { 'A': [], 'B': [], 'C': [], 'D': [] };

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (examsByType[data.type]) {
                        examsByType[data.type].push(data);
                    }
                });

                Object.keys(examsByType).forEach(type => {
                    const containerId = `link-container-${type}`;
                    const messageId = `link-message-${type}`;
                    const container = document.getElementById(containerId);
                    
                    if (examsByType[type].length > 0) {
                        document.getElementById(messageId).classList.add('hidden');
                        const listHtml = examsByType[type].map(exam => {
                            const link = `${window.location.origin}${window.location.pathname}?examId=${exam.id}`;
                            return `<div class="bg-white p-3 rounded-lg flex justify-between items-center shadow-sm">
                                <span class="font-medium text-gray-800">${exam.student.surname} ${exam.student.name} (${exam.student.class}) - ${exam.date}</span>
                                <a href="${link}" target="_blank" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition">Correggi Link 🔗</a>
                            </div>`;
                        }).join('');
                        container.innerHTML = `<h4 class="text-lg font-semibold text-${type === 'A' ? 'red' : type === 'B' ? 'purple' : type === 'C' ? 'teal' : 'yellow'}-600 border-b border-${type === 'A' ? 'red' : type === 'B' ? 'purple' : type === 'C' ? 'teal' : 'yellow'}-300 pb-1">Link di Correzione Generati (Verifica ${type}):</h4>` + listHtml;
                    } else {
                        document.getElementById(messageId).classList.remove('hidden');
                    }
                });

            } catch (e) {
                console.error("Errore nel caricamento dei link di correzione:", e);
            }
        }

        window.addCorrectionLink = (type, examId, nome, cognome, classe, link) => {
            // Funzione di supporto per l'aggiunta dinamica dopo la generazione (senza ricaricare da DB)
            const container = document.getElementById(`link-container-${type}`);
            document.getElementById(`link-message-${type}`).classList.add('hidden');
            
            const newLinkHtml = `
                <div class="bg-white p-3 rounded-lg flex justify-between items-center shadow-sm">
                    <span class="font-medium text-gray-800">${cognome} ${nome} (${classe}) - ${new Date().toISOString().split('T')[0]}</span>
                    <a href="${link}" target="_blank" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition">Correggi Link 🔗</a>
                </div>`;
            
            // Se il container ha solo l'header, aggiungi subito il link. Altrimenti, aggiungilo in testa.
            const header = container.querySelector('h4');
            if (header && container.children.length > 1) {
                header.insertAdjacentHTML('afterend', newLinkHtml);
            } else {
                container.innerHTML = `<h4 class="text-lg font-semibold text-${type === 'A' ? 'red' : type === 'B' ? 'purple' : type === 'C' ? 'teal' : 'yellow'}-600 border-b border-${type === 'A' ? 'red' : type === 'B' ? 'purple' : type === 'C' ? 'teal' : 'yellow'}-300 pb-1">Link di Correzione Generati (Verifica ${type}):</h4>` + newLinkHtml;
            }
        };

        // -------------------------------------------------------------------------
        // LOGICA DI CORREZIONE
        // -------------------------------------------------------------------------

        window.loadCorrectionView = async (examId) => {
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('correction-view').classList.remove('hidden');

            try {
                const examDocRef = window.doc(window.getExamCollectionRef(), examId);
                const docSnap = await window.getDoc(examDocRef);

                if (!docSnap.exists()) {
                    console.error("Verifica non trovata con ID:", examId);
                    window.hideLoading();
                    return;
                }

                currentExamData = docSnap.data();

                // Popola l'intestazione
                document.getElementById('corr-student-name').textContent = `${currentExamData.student.name} ${currentExamData.student.surname}`;
                document.getElementById('corr-class').textContent = currentExamData.student.class;
                document.getElementById('corr-title').textContent = `Tipo ${currentExamData.type} - Data ${currentExamData.date}`;

                // Inizializza i punteggi
                const correction = currentExamData.correction;
                document.getElementById('voto-orale').value = correction.oralGrade || 6.0;

                // Popola il form di correzione
                updateCorrectionForm(currentExamData);
                
                // Aggiorna il voto finale iniziale
                updateFinalGrade();
                
                window.hideLoading();

            } catch (error) {
                console.error("Errore nel caricamento della vista di correzione:", error);
                window.hideLoading();
            }
        };

        function updateCorrectionForm(examData) {
            const form = document.getElementById('correction-form');
            let html = '';
            let currentPoints = 0;

            examData.questions.forEach((q, index) => {
                const qNum = index + 1;
                const qText = q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                const isCorrect = examData.correction.comments[q.id]?.isCorrect || false;
                const comment = examData.correction.comments[q.id]?.comment || '';

                if (isCorrect) currentPoints++;

                html += `
                    <div class="p-5 border-2 ${isCorrect ? 'border-green-400 bg-green-50' : 'border-gray-200 bg-white'} rounded-xl shadow-lg">
                        <h4 class="text-xl font-bold text-gray-800 mb-3">${qNum}. ${qText}</h4>
                        <p class="text-sm font-semibold text-green-700 p-2 bg-green-100 rounded-lg code-font">
                            SOLUZIONE CORRETTA: 
                            <span class="font-extrabold text-green-900 ml-2">${q.correct}</span>
                        </p>
                        <div class="flex items-center space-x-4 mt-4">
                            <label class="flex items-center text-lg font-medium text-gray-700">
                                <input type="checkbox" id="${q.id}-check" class="h-6 w-6 text-indigo-600 rounded" ${isCorrect ? 'checked' : ''} onchange="handleCheck('${q.id}')">
                                Punti assegnati (1)
                            </label>
                        </div>
                        <textarea id="${q.id}-comment" placeholder="Aggiungi un commento sulla risposta dell'alunno..." class="mt-3 p-3 border border-gray-300 rounded-lg w-full resize-y min-h-[80px] focus:ring-indigo-500 focus:border-indigo-500 text-sm">${comment}</textarea>
                    </div>
                `;
            });
            
            form.innerHTML = html;
            document.getElementById('corr-points').textContent = currentPoints;
        }

        window.handleCheck = (qId) => {
            const checkbox = document.getElementById(`${qId}-check`);
            const newStatus = checkbox.checked;
            
            // Aggiorna i punti totali
            let currentPoints = parseInt(document.getElementById('corr-points').textContent);
            currentPoints += newStatus ? 1 : -1;
            document.getElementById('corr-points').textContent = currentPoints;
            
            // Aggiorna l'UI del box
            const parentDiv = checkbox.closest('div.p-5');
            if (newStatus) {
                parentDiv.classList.add('border-green-400', 'bg-green-50');
                parentDiv.classList.remove('border-gray-200', 'bg-white');
            } else {
                parentDiv.classList.remove('border-green-400', 'bg-green-50');
                parentDiv.classList.add('border-gray-200', 'bg-white');
            }
            
            updateFinalGrade();
        };

        window.updateFinalGrade = () => {
            const points = parseInt(document.getElementById('corr-points').textContent);
            const maxPoints = window.MAX_POINTS;
            const oralGrade = parseFloat(document.getElementById('voto-orale').value) || 0;
            
            // Voto scritto convertito in base 10
            const writtenGradeBase10 = (points / maxPoints) * 10;
            document.getElementById('voto-scritto-base').textContent = writtenGradeBase10.toFixed(2);
            
            // Voto finale (70% scritto, 30% orale)
            const finalGrade = (writtenGradeBase10 * 0.7) + (oralGrade * 0.3);
            
            // Arrotonda per difetto
            document.getElementById('corr-grade-floored').textContent = Math.floor(finalGrade).toString();
        };

        // Salva e scarica il PDF dei risultati
        window.saveAndDownloadResultsPDF = async () => {
            if (!currentExamData) {
                console.error("Nessun dato verifica caricato.");
                return;
            }
            
            window.showLoading();

            // 1. Raccogli i dati di correzione
            const correctionData = {
                points: parseInt(document.getElementById('corr-points').textContent),
                writtenGrade: parseFloat(document.getElementById('voto-scritto-base').textContent),
                oralGrade: parseFloat(document.getElementById('voto-orale').value),
                finalGrade: Math.floor(parseFloat(document.getElementById('corr-grade-floored').textContent)),
                comments: {}
            };
            
            currentExamData.questions.forEach(q => {
                const check = document.getElementById(`${q.id}-check`).checked;
                const comment = document.getElementById(`${q.id}-comment`).value.trim();
                correctionData.comments[q.id] = { isCorrect: check, comment: comment };
            });
            
            // Aggiorna i dati nel record di base
            currentExamData.correction = correctionData;
            currentExamData.correctedAt = new Date().toISOString();

            // 2. Salva il record aggiornato su Firestore
            const examDocRef = window.doc(window.getExamCollectionRef(), currentExamData.id);
            try {
                await window.setDoc(examDocRef, currentExamData);
                console.log("Correzione salvata con successo!");
            } catch (e) {
                console.error("Errore nel salvataggio della correzione:", e);
                window.hideLoading();
                return;
            }

            // 3. Genera e scarica il PDF di riepilogo della correzione
            createCorrectionPDF(currentExamData);
            
            window.hideLoading();
            // Opzionale: Torna alla vista principale dopo il salvataggio
            setTimeout(() => {
                window.location.href = window.location.origin + window.location.pathname;
            }, 1000);

        };
        
        function createCorrectionPDF(examData) {
            const correction = examData.correction;
            
            let html = `
            <div class="p-8">
                <div class="print-header">
                    <h1 class="text-2xl font-black text-green-700">RIEPILOGO CORREZIONE VERIFICA</h1>
                    <p class="text-sm text-gray-700">Prof. Giuseppe Borzumati | Data Correzione: ${new Date().toLocaleDateString('it-IT')} | ID: ${examData.id}</p>
                </div>
                <div class="my-4 p-3 border-4 border-yellow-500 bg-yellow-100 rounded-lg text-lg font-bold">
                    <p>ALUNNO: ${examData.student.surname} ${examData.student.name} (${examData.student.class})</p>
                    <p class="mt-2 text-xl font-extrabold text-red-700">VOTO FINALE (Arrotondato): ${correction.finalGrade} / 10</p>
                    <p class="text-base text-gray-800">Punti Ottenuti: ${correction.points} / ${window.MAX_POINTS}</p>
                </div>
                <h2 class="text-xl font-bold text-gray-700 mt-6 mb-3 border-b border-gray-300 pb-1">Commenti e Risultati Dettagliati</h2>
                <ol class="list-none p-0" style="counter-reset: question-counter;">
        `;
            
            examData.questions.forEach((q, index) => {
                const qNum = index + 1;
                const result = correction.comments[q.id];
                const isCorrect = result?.isCorrect;
                const status = isCorrect ? 'CORRETTO' : 'ERRATO';
                const statusClass = isCorrect ? 'text-green-700' : 'text-red-700';
                const commentText = result?.comment || 'Nessun commento lasciato.';

                html += `
                    <li class="question-item" style="border-left: 4px solid ${isCorrect ? '#10b981' : '#ef4444'};">
                        <div class="question-text">${qNum}. ${q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>
                        <p class="text-sm mt-1">
                            Stato: <span class="font-bold ${statusClass}">${status}</span> | Punteggio: <span class="font-bold ${statusClass}">${isCorrect ? '1' : '0'}</span>
                        </p>
                        <p class="text-sm font-semibold text-gray-800 mt-2">Correzione Docente: <span class="font-normal italic">${commentText}</span></p>
                        <p class="text-xs text-gray-500 mt-1">Soluzione: ${q.correct}</p>
                    </li>
                `;
            });

            html += `
                </ol>
                <div class="mt-8 pt-4 border-t border-gray-300 text-xs text-gray-500 text-center">
                    Riepilogo generato dal sistema Borzumati.
                </div>
            </div>
            `;

            const printArea = document.getElementById('print-area');
            printArea.innerHTML = html;

            // Imposta il titolo per il nome del file PDF
            document.title = `Correzione_${examData.student.surname}_${examData.student.class}_${examData.date}_Voto${correction.finalGrade}.pdf`;

            printArea.classList.remove('hidden');
            
            setTimeout(() => {
                window.print();
                printArea.classList.add('hidden');
                document.title = 'Generatore Verifiche Informatica - Borzumati';
            }, 100);
        }

    </script>
</body>
</html>
