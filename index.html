<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Verifiche Informatica - Borzumati</title>
    <!-- Carica Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .code-font { font-family: 'Roboto Mono', monospace; }
        .code-block { background-color: #1e293b; color: #f8fafc; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; }

        /* Stili per la stampa PDF (ottimizzazione 2 pagine A4) */
        @media print {
            body { font-family: sans-serif !important; font-size: 10pt; background: white !important; }
            /* Nasconde tutto tranne l'area di stampa */
            body > *:not(.print-container) { display: none !important; } 
            .print-container { 
                display: block !important; 
                max-width: none !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                box-shadow: none !important; 
                height: auto;
                color: #000; /* Assicura testo nero */
            }
            @page { margin: 1.5cm; } /* Margine leggermente pi√π ampio per leggibilit√† */
            
            .print-header { border-bottom: 3px solid #6366f1; padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
            .print-header h1 { font-size: 16pt !important; font-weight: 900; color: #1e293b; }
            .print-header p { font-size: 10pt !important; color: #374151; }
            
            .question-item { 
                margin-bottom: 2rem; 
                page-break-inside: avoid;
                border-left: 4px solid #6366f1;
                padding-left: 0.75rem;
                counter-increment: question-counter;
                display: flex; /* Flex per allineamento item/numero */
                flex-direction: column;
            }
            .question-item::before {
                content: counter(question-counter) ". ";
                font-weight: bold;
                font-size: 12pt;
                color: #6366f1;
                position: absolute; /* Per non spostare il testo */
                margin-left: -1.5rem; 
            }
            .question-text { font-weight: 700; color: #1f2937; margin-bottom: 0.5rem; white-space: pre-wrap; /* Mantiene la formattazione markdown/nuove linee */ }
            .question-text strong { font-weight: 900; }

            .answer-line { 
                height: 1.2em; 
                display: block; 
                border-bottom: 1px dashed #9ca3af; 
                width: 100%; 
                margin-top: 0.6rem; 
            }
            .solution-box { 
                border: 1px solid #10b981; 
                background-color: #d1fae5; 
                color: #065f46; 
                padding: 0.3rem 0.6rem; 
                border-radius: 4px; 
                margin-top: 0.5rem; 
                font-size: 9pt;
                font-weight: 700;
                white-space: pre-wrap; /* Mantiene la formattazione markdown/nuove linee */
            }
            .solution-label { font-weight: 900; text-decoration: underline; }
        }

        /* Stili per i pulsanti animati */
        .action-button { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); font-weight: 700; position: relative; overflow: hidden; }
        .action-button:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
        .action-button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.2); transform: skewX(-20deg); transition: all 0.7s; }
        .action-button:hover::before { left: 100%; }
        .bg-gradient-blue { background-image: linear-gradient(to right, #4c66ff 0%, #00c6ff 100%); }
        .bg-gradient-green { background-image: linear-gradient(to right, #10b981 0%, #1d7c4c 100%); }
    </style>
</head>
<body class="bg-gray-900 min-h-screen p-4 sm:p-8">

    <!-- Area di caricamento -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex items-center justify-center hidden">
        <div class="text-center text-white">
            <svg class="animate-spin h-10 w-10 text-indigo-400 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-semibold">Caricamento dati in corso... (Connessione a Firebase)</p>
        </div>
    </div>
    
    <!-- Sezione Dati Studente/Docente e Introduzione -->
    <div id="main-view" class="w-full max-w-7xl mx-auto bg-white rounded-xl shadow-[0_25px_50px_-12px_rgba(0,0,0,0.5)] p-6 sm:p-12 mb-8 space-y-10">
        <header class="text-center pb-6 border-b-4 border-indigo-500">
            <h1 class="text-4xl sm:text-6xl font-black leading-tight">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-purple-600"> GENERATORE VERIFICHE INFORMATICA </span>
            </h1>
            <p class="text-xl text-gray-700 mt-2">Prof. Giuseppe Borzumati | 11 Domande Miste Pratica + Teoria Complessa</p>
        </header>

        <!-- Dati Studente per la Generazione (Globali) -->
        <div class="bg-indigo-50 p-8 rounded-2xl shadow-inner border border-indigo-200">
            <h2 class="text-2xl font-bold text-indigo-800 mb-5 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 mr-2 text-indigo-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                </svg> 
                Dati Base
                <span id="teacher-id" class="code-font text-xs ml-4 p-1 bg-indigo-200 text-indigo-800 rounded"></span>
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div> <input type="text" id="nome-studente" placeholder="Nome" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
                <div> <input type="text" id="cognome-studente" placeholder="Cognome" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
                <div> <input type="text" id="classe-studente" placeholder="Classe (es. 4B)" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
                <div> <input type="date" id="data-verifica" value="" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
            </div>
            <p class="text-sm text-indigo-600 mt-4 font-semibold">Tutti i campi sono obbligatori per generare il link di correzione.</p>
        </div>

        <!-- Contenitore delle Verifiche (4 Blocchi) -->
        <div class="space-y-12">

            <!-- BLOCCO 1: Verifiche Numeriche PURE -->
            <div id="blocco-verifica-a" class="p-8 bg-red-50 border-t-8 border-t-red-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-red-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üî¢</span> VERIFICA A: Sistemi di Numerazione Base & Operazioni
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Conversione Base (2, 8, 10, 16), Frazioni Binarie, Numeri Romani e Operazioni Binaria. (11 Domande Miste)</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('A', true)"> üìÑ Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('A', false)"> üéì Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-A" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-red-600 border-b border-red-300 pb-1">Link di Correzione Generati (Verifica A):</h4>
                    <p class="text-sm text-gray-500" id="link-message-A">Nessuna verifica di Tipo A generata.</p>
                </div>
            </div>

            <!-- BLOCCO 2: A + Networking Semplice -->
            <div id="blocco-verifica-b" class="p-8 bg-purple-50 border-t-8 border-t-purple-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-purple-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üåê</span> VERIFICA B: Sistemi di Numerazione + Networking Semplice
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Contenuti della Verifica A + Subnetting Semplice (CIDR, Network/Broadcast ID, Maschera). (11 Domande Miste)</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('B', true)"> üìÑ Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('B', false)"> üéì Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-B" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-purple-600 border-b border-purple-300 pb-1">Link di Correzione Generati (Verifica B):</h4>
                    <p class="text-sm text-gray-500" id="link-message-B">Nessuna verifica di Tipo B generata.</p>
                </div>
            </div>

            <!-- BLOCCO 3: A + Networking Semplice (uguale a B per bilanciamento) -->
            <div id="blocco-verifica-c" class="p-8 bg-teal-50 border-t-8 border-t-teal-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-teal-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üî¨</span> VERIFICA C: Sistemi di Numerazione + Networking Semplice
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Contenuti della Verifica A + Subnetting Semplice (CIDR, Network/Broadcast ID, Maschera). (11 Domande Miste) - Ideale per un'alternativa alla B.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('C', true)"> üìÑ Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('C', false)"> üéì Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-C" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-teal-600 border-b border-teal-300 pb-1">Link di Correzione Generati (Verifica C):</h4>
                    <p class="text-sm text-gray-500" id="link-message-C">Nessuna verifica di Tipo C generata.</p>
                </div>
            </div>
            
            <!-- BLOCCO 4: Riepilogo Completo e Problemi Critici (Verifica D) -->
            <div id="blocco-verifica-d" class="p-8 bg-yellow-50 border-t-8 border-t-yellow-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-yellow-800 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">‚≠ê</span> VERIFICA D: Riepilogo Completo (Complemento a 2, Floating Point, IP Avanzato)
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Mix di tutti gli argomenti avanzati: Complemento a Due, Floating Point e Subnetting complesso (VLSM/CIDR). (11 Domande Miste)</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('D', true)"> üìÑ Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('D', false)"> üéì Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-D" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-yellow-600 border-b border-yellow-300 pb-1">Link di Correzione Generati (Verifica D):</h4>
                    <p class="text-sm text-gray-500" id="link-message-D">Nessuna verifica di Tipo D generata.</p>
                </div>
            </div>

        </div>

        <footer class="text-center pt-8 text-gray-500 text-sm border-t border-gray-200">
            <p>Sistema di Generazione Verifiche v5.2 | Per l'Insegnante Giuseppe Borzumati. Assicurati che il pop-up del browser sia consentito per scaricare il PDF.</p>
        </footer>
    </div>

    <!-- VISTA DI CORREZIONE (Caricata tramite link condivisibile) -->
    <div id="correction-view" class="hidden w-full max-w-5xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10 mb-8 space-y-8">
        <header class="text-center pb-4 border-b-4 border-green-500">
            <h1 class="text-4xl font-extrabold text-green-700 leading-tight">Griglia di Correzione Interattiva</h1>
            <p class="text-lg text-gray-600 mt-1">
                Studente: <span id="corr-student-name" class="font-extrabold text-indigo-600"></span> - 
                Classe: <span id="corr-class" class="font-extrabold text-indigo-600"></span> - 
                Verifica <span id="corr-title" class="font-bold"></span>
            </p>
        </header>

        <!-- Tabella Punteggio e Voto -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 bg-yellow-50 p-6 rounded-xl border-2 border-yellow-300 shadow-lg">
            <div class="col-span-1 lg:col-span-3">
                <h2 class="text-2xl font-bold text-yellow-800 mb-2 border-b border-yellow-400 pb-1">Valutazione</h2>
            </div>
            
            <div class="bg-blue-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-blue-800">Punti Ottenuti:</p>
                <p class="text-4xl font-extrabold text-blue-600 mt-1"><span id="corr-points">0</span> / <span id="corr-max-points">11</span></p>
            </div>
            
            <div class="bg-purple-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-purple-800">Voto Orale (Base 10):</p>
                <input type="number" id="voto-orale" min="0" max="10" step="0.1" value="6.0" onchange="updateFinalGrade()" class="p-2 border-2 border-purple-500 rounded-lg w-full mt-1 text-xl font-bold">
            </div>
            
            <div class="bg-red-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-red-800">Voto Finale (Arrotondato per Difetto):</p>
                <p class="text-4xl font-extrabold text-red-600 mt-1"><span id="corr-grade-floored">0</span> / 10</p>
            </div>
            
            <div class="col-span-1 lg:col-span-3 bg-gray-100 p-4 rounded-lg border border-gray-300" id="conversion-explanation">
                <p class="text-sm font-bold text-gray-700">Formula di Calcolo:</p>
                <code class="code-font text-xs block mt-1 p-2 bg-white rounded"> Voto Scritto Base 10 = (Punti Ottenuti / 11) * 10 = <span id="voto-scritto-base">0.00</span> </code>
                <code class="code-font text-xs block mt-1 p-2 bg-white rounded"> Voto Finale = (Voto Scritto * 0.7) + (Voto Orale * 0.3) </code>
            </div>
        </div>

        <!-- Esercizi con Correzione -->
        <div id="correction-form" class="space-y-6"> 
            <!-- Gli esercizi e i campi di input saranno popolati qui dal JS -->
        </div>

        <button class="action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-lg mt-8 w-full" onclick="saveAndDownloadResultsPDF()"> Salva Risultati e Scarica PDF dei Commenti </button>
        <button class="action-button bg-gray-400 hover:bg-gray-500 text-gray-900 py-3 px-6 rounded-lg text-lg w-full" onclick="window.location.href = window.location.origin + window.location.pathname"> Torna alla Generazione Verifiche </button>
    </div>

    <!-- Contenitore Nascosto per la Stampa PDF (Stile ottimizzato per PDF) -->
    <div id="print-area" class="print-container hidden"></div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Imposta il livello di log per debug
        setLogLevel('Debug');

        // Variabili Globali del Modulo
        window.db = null;
        window.auth = null;
        window.teacherId = null;
        window.MAX_POINTS = 11; // Punti massimi per la verifica (1 punto per domanda)

        // Configurazione Firebase: Usa le variabili globali se disponibili, altrimenti il fallback fornito dall'utente.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Fallback config (DO NOT USE IN PROD)
            apiKey: "AIzaSyDtruKdnoFjMqob-1zf-Zw0hXn8j_YwVio",
            authDomain: "verifichenumeribinari.firebaseapp.com",
            projectId: "verifichenumeribinari",
            storageBucket: "verifichenumeribinari.firebasestorage.app",
            messagingSenderId: "648812468179",
            appId: "1:648812468179:web:1a0e2d65cb1aae28e60126",
            measurementId: "G-K5SL1808G4"
        };
        
        // Variabile ID App (usata per il path Firestore)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Funzione di Inizializzazione Firebase
        async function initializeFirebase() {
            window.showLoading();
            try {
                // 1. Inizializzazione App
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // 2. Autenticazione Anonima o con Token
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }
                
                window.teacherId = window.auth.currentUser.uid;
                
                // 3. Nascondi Overlay e Avvia l'app
                document.getElementById('teacher-id').textContent = `Docente ID: ${window.teacherId.substring(0, 8)}...`;

                // 4. Carica i link di correzione esistenti
                await window.updateLinkContainers();

                // 5. Verifica se √® una vista di correzione
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('examId');
                if (examId) {
                    await window.loadCorrectionView(examId);
                } else {
                    window.showMainView();
                }

            } catch (error) {
                console.error("Errore fatale nell'inizializzazione di Firebase e Auth:", error);
                const errorMsg = "Errore di connessione al database. Controlla la console per i dettagli. (ID App: " + appId + ")";
                const mainView = document.getElementById('main-view');
                mainView.innerHTML = `<div class="text-center text-red-600 p-8 border border-red-300 rounded-xl mt-12">
                                        <p class="text-2xl font-bold">ERRORE FATALE</p>
                                        <p class="mt-2">${errorMsg}</p>
                                      </div>`;
                window.hideLoading();
            }
        }

        // Metodo per ottenere il path corretto per Firestore (pubblico)
        window.getExamCollectionRef = () => {
             return collection(window.db, "artifacts", appId, "public", "data", "exams");
        };

        // ESPORTA LE FUNZIONI DI FIRESTORE NEL CONTESTO GLOBALE
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.doc = doc;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;

        // Esegui l'inizializzazione al caricamento
        window.addEventListener('load', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('data-verifica').value = today;
            document.getElementById('corr-max-points').textContent = window.MAX_POINTS;
            initializeFirebase();
        });
    </script>
    
    <script>
        // -------------------------------------------------------------------------
        // LOGICA DI VISTA E UTILITY
        // -------------------------------------------------------------------------

        let currentExamData = null; // Dati della verifica attualmente in correzione
        
        window.showLoading = () => document.getElementById('loading-overlay').classList.remove('hidden');
        window.hideLoading = () => document.getElementById('loading-overlay').classList.add('hidden');

        // Navigazione tra le viste
        window.showMainView = () => {
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('correction-view').classList.add('hidden');
            window.hideLoading();
        };
        window.showCorrectionView = () => {
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('correction-view').classList.remove('hidden');
            window.hideLoading();
        };

        // Funzione per generare un ID unico
        const generateUniqueID = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 5);

        // Funzione per pulire e standardizzare le risposte (tolleranza)
        const cleanAnswer = (s) => s.toString()
            .trim()
            .toUpperCase()
            .replace(/[^A-Z0-9\.\/\;\-\+\s]/g, '') // Rimuove caratteri non validi
            .replace(/\s+/g, ''); // Rimuove tutti gli spazi

        // Funzione per mostrare un messaggio temporaneo
        const showTempMessage = (containerId, message, type = 'success') => {
            const container = document.getElementById(containerId);
            const originalContent = container.innerHTML;
            const color = type === 'success' ? 'text-green-600' : 'text-red-600';
            container.innerHTML = `<p class="text-lg font-bold ${color}">${message}</p>`;
            setTimeout(() => {
                container.innerHTML = originalContent;
                window.updateLinkContainers(); // Ricarica i link dopo il messaggio
            }, 3000);
        };

        // -------------------------------------------------------------------------
        // FUNZIONI NUMERICHE DI CALCOLO (CRITICHE)
        // -------------------------------------------------------------------------

        // Genera un numero intero casuale in un range (incluso)
        const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        // Funzione per generare un numero binario con parte frazionaria
        function generateBinaryFractional(intBits, fracBits) {
            const integerPart = randInt(1, Math.pow(2, intBits) - 1);
            let fractionalValue = 0;
            let binFractional = '';
            let tempFrac = Math.random(); 
            
            for (let i = 0; i < fracBits; i++) {
                tempFrac *= 2;
                let bit = Math.floor(tempFrac);
                binFractional += bit;
                fractionalValue += bit * Math.pow(2, -(i + 1));
                tempFrac -= bit;
            }

            const decimalValue = integerPart + fractionalValue;
            const binaryValue = integerPart.toString(2) + '.' + binFractional;
            
            return { decimal: parseFloat(decimalValue.toFixed(4)), binary: binaryValue };
        }

        // Funzione per calcolare il Complemento a Due (8 bit)
        function toTwosComplement(num) {
            if (num >= 127 || num < -128) return 'OVERFLOW';
            if (num >= 0) {
                return num.toString(2).padStart(8, '0');
            }
            
            const absNum = Math.abs(num);
            let bin = absNum.toString(2).padStart(8, '0');
            
            // 1. Inverti i bit
            let inverted = [...bin].map(b => b === '0' ? '1' : '0').join('');
            
            // 2. Aggiungi 1 (in binario)
            let carry = 1;
            let twosComp = '';
            for (let i = 7; i >= 0; i--) {
                let bit = parseInt(inverted[i], 10);
                let sum = bit + carry;
                twosComp = (sum % 2) + twosComp;
                carry = Math.floor(sum / 2);
            }
            return twosComp;
        }

        // Calcolo Notazione Scientifica Binaria (Floating Point Semplificato - Mantissa 14 bit, Esponente offset 7)
        function calculateFloatingPoint(dec) {
            let num = Math.abs(dec);
            if (num === 0) return { exponent: 0, mantissa: '0'.repeat(14), result: '0 0000000 00000000000000' };

            const signBit = dec < 0 ? '1' : '0';

            let integerPart = Math.floor(num);
            let fractionalPart = num - integerPart;
            
            let binary = integerPart.toString(2);
            let fracBin = '';
            let tempFrac = fractionalPart;

            // Genera la parte frazionaria binaria
            for (let i = 0; i < 20; i++) {
                tempFrac *= 2;
                let bit = Math.floor(tempFrac);
                fracBin += bit;
                tempFrac -= bit;
            }
            binary += '.' + fracBin;

            let exponentValue;
            let mantissaBits;
            
            let firstOneIndex = binary.indexOf('1');
            let dotIndex = binary.indexOf('.');

            if (dotIndex === -1) dotIndex = binary.length; // Per interi puri

            if (firstOneIndex === -1) { // Caso subnormale/zero
                 exponentValue = -7; // Minimo esponente
                 mantissaBits = '0'.repeat(14);
            } else {
                 if (dotIndex > firstOneIndex) {
                    // Numero >= 1. Sposta la virgola a sinistra.
                    exponentValue = dotIndex - firstOneIndex - 1;
                 } else {
                    // Numero < 1. Sposta la virgola a destra.
                    exponentValue = dotIndex - firstOneIndex;
                 }

                 // Normalizza (rimuovi il punto e il primo '1' implicito)
                 let normalized = binary.replace('.', '');
                 let mantissaStart = normalized.substring(firstOneIndex + 1);
            
                 mantissaBits = mantissaStart.padEnd(14, '0').substring(0, 14);
            }

            const biasedExponent = exponentValue + 7; // Offset 7
            const exponentBinary = biasedExponent.toString(2).padStart(7, '0');
            
            const result = `${signBit} ${exponentBinary} ${mantissaBits}`;

            return { exponent: exponentValue, mantissa: mantissaBits, result: result };
        }


        // Funzione per calcolare ID Rete/Broadcast
        function calculateNetworkIDs(ip, mask) {
            const octets = ip.split('.').map(o => parseInt(o));
            const ipBin = octets.map(o => o.toString(2).padStart(8, '0')).join('');
            
            const networkPart = ipBin.substring(0, mask);
            
            // Network ID (host part = 0)
            const netIDBinary = networkPart.padEnd(32, '0');
            let networkID = [];
            for (let n = 0; n < 4; n++) {
                networkID.push(parseInt(netIDBinary.substring(n * 8, n * 8 + 8), 2));
            }
            const netID = networkID.join('.');

            // Broadcast ID (host part = 1)
            const hostPart = '1'.repeat(32 - mask);
            const broadcastBinary = networkPart + hostPart;
            let broadcastID = [];
            for (let n = 0; n < 4; n++) {
                broadcastID.push(parseInt(broadcastBinary.substring(n * 8, n * 8 + 8), 2));
            }
            const bcastID = broadcastID.join('.');
            
            // Maschera decimale
            const maskBin = '1'.repeat(mask).padEnd(32, '0');
            let maskDec = [];
            for (let n = 0; n < 4; n++) {
                maskDec.push(parseInt(maskBin.substring(n * 8, n * 8 + 8), 2));
            }
            const subnetMask = maskDec.join('.');
            
            const totalHosts = (2 ** (32 - mask)) - 2;

            return { network: netID, broadcast: bcastID, mask: subnetMask, totalHosts: totalHosts };
        }

        // Conversione Decimale a Romano (fino a 999)
        function decToRoman(num) {
            const map = { 1000: 'M', 900: 'CM', 500: 'D', 400: 'CD', 100: 'C', 90: 'XC', 50: 'L', 40: 'XL', 10: 'X', 9: 'IX', 5: 'V', 4: 'IV', 1: 'I' };
            let roman = '';
            for (let i of Object.keys(map).map(Number).sort((a, b) => b - a)) {
                while (num >= i) {
                    roman += map[i];
                    num -= i;
                }
            }
            return roman;
        }

        // -------------------------------------------------------------------------
        // POOL DI GENERATORI DI DOMANDE MISTE (11)
        // -------------------------------------------------------------------------
        // Le 11 domande sono fisse per tipo, ma i valori generati sono casuali.

        function generateMixedQuestion(qNum, type) {
            let question = { id: generateUniqueID(), type: type, correct: '', text: '' };
            let num1, num2, ip, mask, result, cidr;

            switch (qNum % 11) {
                // Q1: Conversione Decimale a Binario + Teoria (A, B, C, D)
                case 0:
                    num1 = randInt(150, 511);
                    result = num1.toString(2);
                    question.text = `**PARTE PRATICA:** Converti il numero Decimale **${num1}** in **Binario** (base 2). 
                        **PARTE TEORICA:** Spiega in modo dettagliato come la grandezza del numero di bit utilizzati influenzi la **risoluzione** (precisione) e l'**intervallo** (range) dei valori rappresentabili. Fornisci un esempio numerico a supporto.`;
                    question.correct = result;
                    break;
                
                // Q2: Conversione Esadecimale a Decimale + Teoria (A, B, C, D)
                case 1:
                    num1 = randInt(256, 1024);
                    const hexInput = num1.toString(16).toUpperCase();
                    result = num1.toString();
                    question.text = `**PARTE PRATICA:** Converti il numero Esadecimale **${hexInput}** in **Decimale** (base 10).
                        **PARTE TEORICA:** Confronta l'uso della base 16 (Esadecimale) rispetto alla base 2 (Binario) nell'ambito della programmazione a basso livello. Perch√© l'Esadecimale √® preferito per la rappresentazione di grandi indirizzi di memoria (es. in architettura x64)?`;
                    question.correct = result;
                    break;

                // Q3: Frazione Binaria a Decimale + Teoria (A, B, C, D)
                case 2:
                    const fracNum = generateBinaryFractional(5, 5);
                    result = fracNum.decimal.toFixed(3);
                    question.text = `**PARTE PRATICA:** Dato il numero Binario con la virgola **${fracNum.binary}**, calcola il suo equivalente in Base **DECIMALE** (risultato con 3 cifre decimali, separatore punto).
                        **PARTE TEORICA:** Descrivi il concetto di **errore di rappresentazione** nelle frazioni binarie. Fornisci un esempio di un numero decimale che **non pu√≤** essere rappresentato esattamente in binario anche con molti bit frazionari e spiega il motivo.`;
                    question.correct = result;
                    break;

                // Q4: Decimale a Romani + Teoria (A, B, C, D)
                case 3:
                    num1 = randInt(100, 999);
                    result = decToRoman(num1);
                    question.text = `**PARTE PRATICA:** Converti il numero Decimale **${num1}** nel suo equivalente in **Numeri Romani**.
                        **PARTE TEORICA:** Spiega perch√© i Numeri Romani non sono un sistema di numerazione **posizionale** come il Decimale o il Binario. Quali sono le due regole fondamentali (additiva e sottrattiva) e perch√© quella sottrattiva introduce ambiguit√† che non esistono nei sistemi posizionali?`;
                    question.correct = result;
                    break;

                // Q5: Operazione Binaria (Addizione) + Teoria (A, B, C, D)
                case 4:
                    num1 = randInt(10, 30);
                    num2 = randInt(5, 20);
                    const bin1 = num1.toString(2).padStart(6, '0');
                    const bin2 = num2.toString(2).padStart(6, '0');
                    result = (num1 + num2).toString(2);
                    question.text = `**PARTE PRATICA:** Esegui l'**addizione binaria** tra **${bin1}** e **${bin2}**. (Mostra il riporto e il risultato finale).
                        **PARTE TEORICA:** Descrivi il concetto di **Overflow** nelle operazioni binarie con un numero fisso di bit. Fornisci un esempio di addizione con 4 bit che produce un overflow e spiega perch√© questo problema non esiste nei sistemi a lunghezza variabile (come quelli usati nei linguaggi di alto livello).`;
                    question.correct = result;
                    break;
                
                // Q6: Conversione Binario a Ottale + Teoria (A, B, C, D)
                case 5:
                    num1 = randInt(64, 255);
                    const binInput = num1.toString(2);
                    result = num1.toString(8);
                    question.text = `**PARTE PRATICA:** Converti il numero Binario **${binInput}** in **Ottale** (base 8).
                        **PARTE TEORICA:** Spiega perch√© la conversione Binario $\leftrightarrow$ Ottale (e Binario $\leftrightarrow$ Esadecimale) √® considerata la pi√π semplice. Descrivi il metodo di raggruppamento dei bit per questa conversione e perch√© funziona.`;
                    question.correct = result;
                    break;

                // Q7: Conversione Decimale a Binario (8 bit) per Ca2 (Solo D)
                case 6:
                    if (type === 'D') {
                        num1 = randInt(-128, 127); // Range 8 bit Ca2
                        if (num1 === 0) num1 = 5; // Evita lo zero
                        result = toTwosComplement(num1);
                        question.text = `**PARTE PRATICA:** Calcola la rappresentazione in **Complemento a Due (C2)** su **8 bit** del numero Decimale **${num1}**. (Mostra i passaggi: 1. Valore Assoluto in Binario 2. Complemento a Uno 3. Complemento a Due).
                            **PARTE TEORICA:** Spiega il vantaggio principale del Complemento a Due rispetto al sistema Segno-Grandezza per la rappresentazione dei numeri negativi in una ALU.`;
                        question.correct = result;
                    } else {
                        // Fallback per A, B, C
                        num1 = randInt(10, 50);
                        num2 = randInt(1, 10);
                        result = (num1 - num2).toString(2);
                        question.text = `**PARTE PRATICA:** Esegui la **sottrazione binaria** $( ${num1.toString(2)} )_2 - ( ${num2.toString(2)} )_2$. (Converti il secondo numero in C2 e somma).
                            **PARTE TEORICA:** Perch√© l'informatica moderna evita la sottrazione diretta in favore dell'addizione con complemento?`;
                        question.correct = result;
                    }
                    break;

                // Q8: Subnetting Semplice (B, C) / Floating Point (D)
                case 7:
                    if (type === 'D') {
                        num1 = parseFloat(randInt(1, 100) / 10).toFixed(2);
                        const fpResult = calculateFloatingPoint(parseFloat(num1));
                        result = fpResult.result.replace(/\s/g, '');
                        question.text = `**PARTE PRATICA:** Converti il numero Decimale **${num1}** in notazione **Floating Point Semplificata** (1 bit Segno, 7 bit Esponente (Bias 7), 14 bit Mantissa). (Fornisci il risultato come: S EEEEEEE MMMMMMMMMMMMMM).
                            **PARTE TEORICA:** Definisci i concetti di **Bias** nell'Esponente e **Bit Implicito** nella Mantissa e perch√© sono cruciali per massimizzare il range e la precisione nei formati Floating Point (come IEEE 754).`;
                        question.correct = result;
                    } else {
                        // Subnetting Semplice (B, C)
                        const octet1 = randInt(192, 223); // Class C or lower for simpler CIDR
                        ip = `${octet1}.${randInt(1, 254)}.${randInt(1, 254)}.${randInt(1, 254)}`;
                        cidr = randInt(20, 28);
                        const netInfo = calculateNetworkIDs(ip, cidr);
                        result = netInfo.mask;
                        question.text = `**PARTE PRATICA:** Data la notazione CIDR **${ip}/${cidr}**, calcola la **Subnet Mask** in notazione Decimale Puntata (es. 255.255.255.0).
                            **PARTE TEORICA:** Definisci e confronta le classi di indirizzi IP tradizionali (**Classe A, B, C**) con l'approccio moderno **CIDR**. Qual √® il principale vantaggio del CIDR in termini di gestione dello spazio di indirizzamento?`;
                        question.correct = result;
                    }
                    break;

                // Q9: Subnetting Semplice (B, C) / Subnetting Avanzato (D)
                case 8:
                    const octet1_9 = randInt(192, 223);
                    ip = `${octet1_9}.${randInt(1, 254)}.${randInt(1, 254)}.${randInt(1, 254)}`;
                    cidr = randInt(20, 28);
                    const netInfo = calculateNetworkIDs(ip, cidr);
                    
                    if (type === 'D') {
                        // Avanzato: Numero di Host
                        result = netInfo.totalHosts.toString();
                        question.text = `**PARTE PRATICA:** Data la notazione CIDR **${ip}/${cidr}**, calcola il **numero massimo di Host utilizzabili** (esclusi Network ID e Broadcast ID).
                            **PARTE TEORICA:** Spiega il concetto di **VLSM (Variable Length Subnet Masking)**. Perch√© il VLSM √® essenziale per ottimizzare l'uso degli indirizzi IP in reti complesse, a differenza del subnetting tradizionale?`;
                        question.correct = result;
                    } else {
                        // Semplice: Network ID
                        result = netInfo.network;
                        question.text = `**PARTE PRATICA:** Data la notazione CIDR **${ip}/${cidr}**, calcola l'**Indirizzo di Rete (Network ID)** in notazione Decimale Puntata.
                            **PARTE TEORICA:** Definisci cosa sono l'**Indirizzo di Rete** e l'**Indirizzo di Broadcast**. Perch√© un host non pu√≤ avere come indirizzo l'Indirizzo di Rete o l'Indirizzo di Broadcast?`;
                        question.correct = result;
                    }
                    break;

                // Q10: Subnetting Semplice (B, C) / Subnetting Avanzato (D)
                case 9:
                    const octet1_10 = randInt(192, 223);
                    ip = `${octet1_10}.${randInt(1, 254)}.${randInt(1, 254)}.${randInt(1, 254)}`;
                    cidr = randInt(20, 28);
                    const netInfo2 = calculateNetworkIDs(ip, cidr);
                    
                    if (type === 'D') {
                        // Avanzato: Broadcast ID
                        result = netInfo2.broadcast;
                        question.text = `**PARTE PRATICA:** Data la notazione CIDR **${ip}/${cidr}**, calcola l'**Indirizzo di Broadcast** in notazione Decimale Puntata.
                            **PARTE TEORICA:** Descrivi il processo di **Routing** in una rete. Qual √® la funzione fondamentale di un **Router** in un contesto di subnetting e come utilizza la Subnet Mask per prendere decisioni?`;
                        question.correct = result;
                    } else {
                        // Semplice: Broadcast ID
                        result = netInfo2.broadcast;
                        question.text = `**PARTE PRATICA:** Data la notazione CIDR **${ip}/${cidr}**, calcola l'**Indirizzo di Broadcast** in notazione Decimale Puntata.
                            **PARTE TEORICA:** Spiega la relazione tra la **Subnet Mask** e il **numero di host** disponibili in una sottorete. In che modo l'aumento dei bit di host (diminuendo il CIDR) influisce sul numero massimo di dispositivi?`;
                        question.correct = result;
                    }
                    break;

                // Q11: Conversione Ottale a Esadecimale + Teoria (A, B, C, D)
                case 10:
                    num1 = randInt(64, 255);
                    const octalInput = num1.toString(8);
                    result = num1.toString(16).toUpperCase();
                    question.text = `**PARTE PRATICA:** Converti il numero Ottale **${octalInput}** in **Esadecimale** (base 16).
                        **PARTE TEORICA:** Descrivi e confronta i concetti di **Dato Analogico** e **Dato Digitale**. Qual √® il ruolo del **campionamento** e della **quantizzazione** nel processo di conversione di un dato analogico in digitale (es. un suono o un'immagine)?`;
                    question.correct = result;
                    break;
            }

            return question;
        }

        function generateQuestions(type) {
            const questions = [];
            for (let i = 0; i < window.MAX_POINTS; i++) {
                questions.push(generateMixedQuestion(i, type));
            }
            return questions;
        }

        // -------------------------------------------------------------------------
        // FUNZIONE DI GENERAZIONE E SALVATAGGIO SU FIRESTORE
        // -------------------------------------------------------------------------

        async function handleGeneration(type, isStudentPDF) {
            window.showLoading();
            const nome = document.getElementById('nome-studente').value.trim();
            const cognome = document.getElementById('cognome-studente').value.trim();
            const classe = document.getElementById('classe-studente').value.trim();
            const data = document.getElementById('data-verifica').value;

            if (!nome || !cognome || !classe || !data) {
                showTempMessage(`link-container-${type}`, "ERRORE: Compila tutti i campi studente prima di generare.", 'error');
                window.hideLoading();
                return;
            }

            const examId = generateUniqueID();
            const questions = generateQuestions(type);
            
            const examData = {
                examId: examId,
                teacherId: window.teacherId,
                type: type,
                studentName: nome,
                studentSurname: cognome,
                studentClass: classe,
                date: data,
                questions: questions,
                // Inizializza i campi per la correzione
                corrected: false,
                finalGrade: null,
                correctionLink: window.location.origin + window.location.pathname + `?examId=${examId}`,
                createdAt: new Date().toISOString()
            };

            try {
                // 1. Salva la verifica su Firestore (path pubblico)
                const docRef = window.doc(window.getExamCollectionRef(), examId);
                await window.setDoc(docRef, examData);

                // 2. Genera il PDF
                generatePDF(examData, isStudentPDF);

                // 3. Aggiorna l'interfaccia con il link di correzione
                await updateLinkContainers();
                showTempMessage(`link-container-${type}`, "Verifica generata con successo! PDF in download/stampa. Link salvato.", 'success');
                
            } catch (error) {
                console.error("Errore nel salvataggio della verifica:", error);
                showTempMessage(`link-container-${type}`, "ERRORE: Impossibile salvare la verifica nel database. Controlla la console.", 'error');
            } finally {
                window.hideLoading();
            }
        }

        // -------------------------------------------------------------------------
        // FUNZIONE DI GENERAZIONE E STAMPA PDF (Download Simil-Diretto)
        // -------------------------------------------------------------------------

        function generatePDF(examData, isStudent) {
            const printArea = document.getElementById('print-area');
            const examTitle = `Verifica di Informatica (Tipo ${examData.type})`;
            const filename = `${examData.date}_Verifica_${examData.type}_${examData.studentSurname}.pdf`;
            
            // 1. Costruisci l'Header HTML
            let printHTML = `
                <div class="print-header text-gray-800">
                    <h1 class="text-3xl font-black">${examTitle}</h1>
                    <p class="text-sm">Prof. Borzumati | Data: ${examData.date} | Studente: ${examData.studentName} ${examData.studentSurname} (${examData.studentClass})</p>
                    ${isStudent ? `<p class="mt-1 text-sm font-bold text-red-600">Punti totali: ${window.MAX_POINTS}. Rispondi in modo esaustivo. Buona fortuna!</p>` : `<p class="mt-1 text-sm font-bold text-green-700">VERSIONE DOCENTE CON SOLUZIONI</p>`}
                </div>
                <div class="questions-list">
            `;

            // 2. Aggiungi le domande
            examData.questions.forEach((q, index) => {
                const questionNumber = index + 1;
                printHTML += `
                    <div class="question-item">
                        <p class="question-text">${q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>
                        ${!isStudent ? `<div class="solution-box"><span class="solution-label">SOLUZIONE:</span> ${q.correct}</div>` : ''}
                        
                        <!-- Spazio per la risposta dell'alunno (linee) -->
                        <span class="answer-line"></span>
                        <span class="answer-line"></span>
                        <span class="answer-line"></span>
                        <span class="answer-line"></span>
                    </div>
                `;
            });

            printHTML += `</div>`;

            // 3. Inserisci e stampa
            printArea.innerHTML = printHTML;
            printArea.classList.remove('hidden');

            // Istruzioni per il browser per forzare il download via stampa
            window.document.title = filename.replace('.pdf', ''); // Imposta il titolo per il PDF
            window.print();
            window.document.title = 'Generatore Verifiche Informatica - Borzumati'; // Ripristina il titolo

            // Pulisci l'area di stampa e nascondila
            printArea.classList.add('hidden');
            printArea.innerHTML = '';
        }

        // -------------------------------------------------------------------------
        // LOGICA DI CARICAMENTO E CORREZIONE DEI LINK
        // -------------------------------------------------------------------------

        window.updateLinkContainers = async () => {
            if (!window.db || !window.teacherId) return;

            const examQuery = window.query(
                window.getExamCollectionRef(),
                window.where("teacherId", "==", window.teacherId)
            );

            try {
                const querySnapshot = await window.getDocs(examQuery);
                const examsByType = { 'A': [], 'B': [], 'C': [], 'D': [] };

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (examsByType[data.type]) {
                        examsByType[data.type].push(data);
                    }
                });

                // Ordina per data/ora decrescente e aggiorna i contenitori
                ['A', 'B', 'C', 'D'].forEach(type => {
                    const container = document.getElementById(`link-container-${type}`);
                    const exams = examsByType[type].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    if (exams.length === 0) {
                        document.getElementById(`link-message-${type}`).textContent = `Nessuna verifica di Tipo ${type} generata.`;
                        return;
                    }

                    let listHTML = `<h4 class="text-lg font-semibold text-${type === 'A' ? 'red' : type === 'B' ? 'purple' : type === 'C' ? 'teal' : 'yellow'}-600 border-b border-${type === 'A' ? 'red' : type === 'B' ? 'purple' : type === 'C' ? 'teal' : 'yellow'}-300 pb-1">Link di Correzione Generati (Verifica ${type}):</h4>`;
                    listHTML += `<ul class="space-y-2">`;
                    
                    exams.forEach(exam => {
                        const isCorrected = exam.corrected;
                        const statusClass = isCorrected ? 'text-green-600 font-bold' : 'text-orange-500';
                        const statusText = isCorrected ? `(Corretto: Voto ${Math.floor(exam.finalGrade)})` : `(Da Correggere)`;
                        
                        listHTML += `
                            <li class="text-sm flex justify-between items-center p-2 rounded-lg bg-white shadow-sm hover:bg-gray-50">
                                <div>
                                    <span class="font-semibold">${exam.studentName} ${exam.studentSurname} (${exam.studentClass})</span>
                                    <span class="text-xs text-gray-500 ml-2"> - ${exam.date}</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="${statusClass} text-xs mr-3">${statusText}</span>
                                    <a href="${exam.correctionLink}" class="text-indigo-500 hover:text-indigo-700 font-medium text-xs border border-indigo-200 rounded-full px-3 py-1 transition-colors">Apri Correzione</a>
                                </div>
                            </li>
                        `;
                    });
                    listHTML += `</ul>`;
                    container.innerHTML = listHTML;
                });

            } catch (error) {
                console.error("Errore nel caricamento dei link:", error);
            }
        };

        window.loadCorrectionView = async (examId) => {
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('correction-view').classList.remove('hidden');

            try {
                const docRef = window.doc(window.getExamCollectionRef(), examId);
                const docSnap = await window.getDoc(docRef);

                if (!docSnap.exists()) {
                    console.error("Verifica non trovata!");
                    document.getElementById('correction-view').innerHTML = `<p class="text-red-500 text-center text-xl mt-10">Verifica non trovata o ID non valido.</p>`;
                    return;
                }

                currentExamData = docSnap.data();
                
                // Popola intestazione
                document.getElementById('corr-student-name').textContent = `${currentExamData.studentName} ${currentExamData.studentSurname}`;
                document.getElementById('corr-class').textContent = currentExamData.studentClass;
                document.getElementById('corr-title').textContent = `Tipo ${currentExamData.type} del ${currentExamData.date}`;
                document.getElementById('voto-orale').value = currentExamData.oralGrade || 6.0;

                // Popola il form di correzione
                const formContainer = document.getElementById('correction-form');
                formContainer.innerHTML = '';
                let formHTML = '';
                
                currentExamData.questions.forEach((q, index) => {
                    const inputId = `correction-input-${q.id}`;
                    const points = q.points || 0;
                    const comment = q.comment || '';

                    formHTML += `
                        <div class="p-5 bg-gray-50 rounded-lg shadow-md border-l-4 border-indigo-500">
                            <h4 class="text-xl font-bold text-gray-800 mb-2">Domanda ${index + 1}:</h4>
                            <p class="text-gray-700 whitespace-pre-wrap">${q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>

                            <div class="mt-4 p-3 bg-green-100 rounded-lg code-font text-sm text-green-800">
                                <span class="font-bold">SOLUZIONE CORRETTA:</span> <span class="select-all">${q.correct}</span>
                            </div>

                            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Punti Assegnati (0 o 1)</label>
                                    <input type="number" id="points-${q.id}" min="0" max="1" step="1" value="${points}" 
                                           onchange="window.updateQuestionScore('${q.id}', this.value)" 
                                           class="p-2 border border-gray-300 rounded-lg w-full text-lg font-bold">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Commento (Opzionale)</label>
                                    <input type="text" id="comment-${q.id}" value="${comment}" placeholder="Aggiungi un commento per il PDF dei risultati" 
                                           class="p-2 border border-gray-300 rounded-lg w-full">
                                </div>
                            </div>
                        </div>
                    `;
                });
                formContainer.innerHTML = formHTML;
                window.updateTotalScore();
            } catch (error) {
                console.error("Errore nel caricamento della vista di correzione:", error);
                document.getElementById('correction-view').innerHTML = `<p class="text-red-500 text-center text-xl mt-10">Errore: ${error.message}</p>`;
            } finally {
                window.hideLoading();
            }
        };

        window.updateQuestionScore = (questionId, newScore) => {
            const score = parseInt(newScore, 10);
            const questionIndex = currentExamData.questions.findIndex(q => q.id === questionId);
            
            if (questionIndex !== -1 && score >= 0 && score <= 1) {
                currentExamData.questions[questionIndex].points = score;
                window.updateTotalScore();
            }
        };

        window.updateTotalScore = () => {
            if (!currentExamData) return;
            const totalPoints = currentExamData.questions.reduce((sum, q) => sum + (q.points || 0), 0);
            document.getElementById('corr-points').textContent = totalPoints;
            updateFinalGrade(totalPoints);
        };

        function updateFinalGrade(totalPoints = null) {
            const currentPoints = totalPoints !== null ? totalPoints : parseInt(document.getElementById('corr-points').textContent, 10);
            const oralGrade = parseFloat(document.getElementById('voto-orale').value) || 0;
            
            // Calcolo Voto Scritto Base 10: (Punti / Max_Points) * 10
            const writtenGradeBase10 = (currentPoints / window.MAX_POINTS) * 10;
            
            // Calcolo Voto Finale Pesato: (Scritto * 0.7) + (Orale * 0.3)
            const finalGrade = (writtenGradeBase10 * 0.7) + (oralGrade * 0.3);
            
            document.getElementById('voto-scritto-base').textContent = writtenGradeBase10.toFixed(2);
            document.getElementById('corr-grade-floored').textContent = Math.floor(finalGrade);
            
            currentExamData.finalGrade = finalGrade;
            currentExamData.writtenGradeBase10 = writtenGradeBase10;
            currentExamData.oralGrade = oralGrade;
        }


        // -------------------------------------------------------------------------
        // SALVATAGGIO FINALE E DOWNLOAD PDF RISULTATI
        // -------------------------------------------------------------------------

        window.saveAndDownloadResultsPDF = async () => {
            window.showLoading();

            // 1. Aggiorna i commenti nel modello di dati locale
            currentExamData.questions.forEach(q => {
                const commentInput = document.getElementById(`comment-${q.id}`);
                if (commentInput) {
                    q.comment = commentInput.value.trim();
                }
            });
            
            // 2. Aggiorna lo stato di correzione
            currentExamData.corrected = true;
            
            // 3. Salvataggio su Firestore
            try {
                const docRef = window.doc(window.getExamCollectionRef(), currentExamData.examId);
                // JSON.parse/stringify per garantire che l'oggetto sia piatto e sicuro
                await window.setDoc(docRef, currentExamData);
                
                // 4. Genera e Stampa il PDF dei Risultati
                generateResultsPDF(currentExamData);

                // 5. Feedback e aggiornamento
                showTempMessage(`correction-form`, "Risultati salvati con successo! PDF dei commenti in download/stampa.", 'success');
                await window.updateLinkContainers(); // Aggiorna la lista nella main view
            } catch (error) {
                console.error("Errore nel salvataggio dei risultati:", error);
                showTempMessage(`correction-form`, "ERRORE: Impossibile salvare i risultati nel database. Controlla la console.", 'error');
            } finally {
                window.hideLoading();
            }
        };


        function generateResultsPDF(examData) {
            const printArea = document.getElementById('print-area');
            const examTitle = `RISULTATI - Verifica di Informatica (Tipo ${examData.type})`;
            const filename = `RISULTATI_${examData.date}_${examData.studentSurname}.pdf`;
            const currentPoints = parseInt(document.getElementById('corr-points').textContent, 10);
            const finalGradeFloored = document.getElementById('corr-grade-floored').textContent;

            // 1. Costruisci l'Header HTML per i risultati
            let printHTML = `
                <div class="print-header text-gray-800" style="border-bottom-color: #10b981;">
                    <h1 class="text-3xl font-black">${examTitle}</h1>
                    <p class="text-base font-semibold">Studente: ${examData.studentName} ${examData.studentSurname} (${examData.studentClass}) | Data: ${examData.date}</p>
                    <p class="text-xl mt-3 font-extrabold text-green-700">VOTO FINALE: ${finalGradeFloored} / 10</p>
                    <p class="text-lg font-bold text-blue-600">Punti Ottenuti: ${currentPoints} / ${window.MAX_POINTS}</p>
                    <p class="text-sm text-gray-500 mt-2">Correzione basata sulla formula: (Voto Scritto x 70%) + (Voto Orale ${examData.oralGrade} x 30%)</p>
                </div>
                <div class="questions-list" style="counter-reset: question-counter;">
            `;

            // 2. Aggiungi le domande con commenti
            examData.questions.forEach((q, index) => {
                const isCorrect = (q.points || 0) === 1;
                const statusIcon = isCorrect ? '‚úîÔ∏è' : '‚ùå';
                const statusColor = isCorrect ? '#059669' : '#ef4444';
                const commentText = q.comment || 'Nessun commento fornito.';
                
                printHTML += `
                    <div class="question-item" style="border-left-color: ${statusColor}; margin-bottom: 2.5rem;">
                        <p class="question-text" style="color: ${statusColor};">
                            ${statusIcon} Domanda sulla traccia ${examData.type}: ${q.text.split('**')[0].trim()}
                            <span class="ml-4 text-sm font-normal text-gray-600">(Punti: ${q.points || 0} / 1)</span>
                        </p>
                        <div class="solution-box" style="border: 1px dashed ${statusColor}; background-color: #f3f4f6; color: #1f2937;">
                            <span class="solution-label" style="text-decoration: none; color: ${statusColor};">COMMENTO DOCENTE:</span> ${commentText}
                        </div>
                    </div>
                `;
            });

            printHTML += `</div>`;

            // 3. Inserisci e stampa
            printArea.innerHTML = printHTML;
            printArea.classList.remove('hidden');

            // Istruzioni per il browser per forzare il download via stampa
            window.document.title = filename.replace('.pdf', '');
            window.print();
            window.document.title = 'Griglia di Correzione Interattiva'; // Ripristina il titolo per la vista di correzione

            // Pulisci l'area di stampa e nascondila
            printArea.classList.add('hidden');
            printArea.innerHTML = '';
        }
    </script>
</body>
</html>
